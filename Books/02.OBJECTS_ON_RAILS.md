# OBJECTS on RAILS

> By AVDI GRIMM

[ğŸ Home](https://github.com/batboy118/Study_Note)

[â—€Previous page ](./README.md)

---

<!-- TOC -->

- 

<!-- /TOC -->

## 1. Yet another frickin' blog app

ìƒˆ ë¸”ë¡œê·¸ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ë§Œë“¤ì–´ë³´ì. 

```
rails new bloog --skip-test-unit --skip-prototype
```

> í”„ë¡œì íŠ¸ ì´ë¦„ì„ blogë¼ê³  í•˜ì§€ì•Šì€ ì´ìœ ëŠ”, Class ì´ë¦„ ì¤‘ Blogë¥¼ ì‚¬ìš©í•  ê³„íšì´ê¸° ë•Œë¬¸ì´ë‹¤. ë§Œì•½ ì´ë¦„ì´ ê°™ë‹¤ë©´ ì¶©ëŒì´ ë°œìƒí•  ê²ƒì´ë‹¤. 

í™ˆí˜ì´ì§€ì˜ ì²« í™”ë©´ë¶€í„° ì‹œì‘í•˜ëŠ” ê²ƒì´ ì¢‹ì„ ê²ƒ ê°™ë‹¤. routeë¥¼ ì„¤ì •í•´ ì£¼ì.

```ruby
root to: "blog#index"
```

ë¼ìš°íŠ¸ê°€ ë™ì‘í•˜ë„ë¡ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ë§Œë“ ë‹¤.

```
rails g controller blog index
```

> ì´ë ‡ê²Œ ë§Œë“¤ë©´ blog ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ë§Œë“¤ì–´ ì£¼ë©° ë‚´ë¶€ì— index ë©”ì„œë“œë¥¼ ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ ì¤€ë‹¤.

ì´ì œ ë·°ì™€ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ì‘ì„±í•˜ì.

ë·°ì—ì„œëŠ” @blogì˜ íƒ€ì´í‹€ê³¼ ì„œë¸Œíƒ€ì´ë¸”ì„ í™”ë©´ì— ì¶œë ¥í•œë‹¤.

```erb
<!-- app/views/blog/index.html.erb -->
<h1><%= @blog.title %></h1>
<h2><%= @blog.subtitle %></h2>
```

ë·°ì—ì„œ @blogê°ì²´ë¥¼ í•„ìš”ë¡œ í•˜ê¸° ë•Œë¬¸ì— ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ìƒì„±í•´ì¤€ë‹¤.

```ruby
# app/controllers/blog_controller.rb
class BlogController < ApplicationController
  def index
    @blog = Blog.new
  end
end
```

Blogë¼ëŠ” í´ë˜ìŠ¤ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ê¸° ë–„ë¬¸ì—, Blogëª¨ë¸ì´ í•„ìš”í•˜ë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

```ruby
# app/models/blog.rb
class Blog
  def title
    "Watching Paint Dry"
  end
  def subtitle
    "The trusted source for drying paint news & opinion"
  end
end
```

ì„œë²„ë¥¼ ëŒë¦¬ë©´ ê¸°ë³¸ì ì¸ í˜ì´ì§€ê°€ ë³´ì´ê²Œ ëœë‹¤.

## 2. Adding blog entries

ì—”íŠ¸ë¦¬ê°€ ì—†ëŠ” ë¸”ë¡œê·¸ëŠ” ìœ ìš©í•˜ì§€ ì•Šë‹¤. ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ë“¤ì„ appì— ì¶”ê°€í•˜ì. ë‹¨ìˆœí•œ ì •ì  ë¬¸ìì—´ë³´ë‹¤ ë³µì¡í•œ ê²ƒì„ ì¶”ê°€í•˜ê¸° ë•Œë¬¸ì—, TDDë¥¼ í•  ê²ƒì´ë‹¤. í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ëŠ” MiniTest/Specì„ ì´ìš©í•œë‹¤.

```ruby
# spec/models/blog_spec.rb
require 'minitest/autorun'
require_relative '../../app/models/blog'
describe Blog do
  before do
    @it = Blog.new
  end
  it "has no entries" do
    @it.entries.must_be_empty
  end
end
```

> RSpec ê¸°ë³¸ êµ¬ì¡°
>
> - í…ŒìŠ¤íŠ¸ì˜ ê¸°ëŒ€ë˜ëŠ” ê°’ê³¼ ì‹¤ì œ ê°’ì„ ë¹„êµí•˜ì—¬ ì„±ê³µ ì—¬ë¶€ë¥¼ ë¦¬í„´í•´ì¤ë‹ˆë‹¤.
>
>   `expect(í…ŒìŠ¤íŠ¸ ê°ì²´).to ë¹„êµí•˜ëŠ” Matcher(ì˜ˆìƒë˜ëŠ” ê°’)`
>
> - describeëŠ” í…ŒìŠ¤íŠ¸ ê·¸ë£¹ì„ ë§Œë“ ë‹¤. describe ë‚´ë¶€ì—ë„ describeë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤.
>
> - ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ê¸° ìœ„í•´ `before do ~ end` ë¥¼ ì‚¬ìš©
> - itëŠ” í•˜ë‚˜ì˜ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ì˜ë¯¸í•œë‹¤. itëŠ” contextì™€ ì¡°í•©í•´ì„œ ì‚¬ìš©í•œë‹¤. ë³´í†µ contextëŠ” `ì–¸ì œ`ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.

í•˜ì§€ë§Œ, blog í´ë˜ìŠ¤ì— entriesê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤.

```ruby
class Blog
    attr_reader :entries
    def initialize
        @entries = []
    end
    # ...
end
```

ë¡œ ìˆ˜ì •í›„ `ruby spec/models/blog_spec.rb`ì„ ì‹¤í–‰í•˜ë©´ í…ŒìŠ¤íŠ¸ê°€ í†µê³¼ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

### Placeholder blog entries

ì´ì œ entries ì†ì„±ì„ Blog í´ë˜ìŠ¤ì— ë§Œë“¤ì—ˆì§€ë§Œ, ê·¸ ì•ˆì—ëŠ” ì•„ë¬´ê²ƒë„ ì—†ë‹¤. BlogControllerì— ì„ì‹œ ì˜ˆì œ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•´ë³´ì.

```ruby
def index
    @blog = Blog.new
    post1 = @blog.new_post
    post1.title = "Paint just applied"
    post1.body = "Paint just applied. It's a lovely orangey-purple!"
    post1.publish
    post2 = @blog.new_post(title: "Still wet")
    post2.body = "Paint is still quite wet. No bubbling yet!"
    post2.publish
end
```

í•˜ì§€ë§Œ, new_postë¼ëŠ” ë©”ì„œë“œëŠ” ì•„ì§ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤. ì½”ë“œë¥¼ ì§œë³´ì.

### Making new entries

new_post ë©”ì„œë“œë¥¼ ëª…ì‹œí•˜ì. new_post ë©”ì„œë“œëŠ” Blog ê°ì²´ì™€ ì—°ê´€ì´ ìˆëŠ” ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ê°ì²´ë¥¼ ë¦¬í„´í•œë‹¤. ê·¸ëŸ¬ë‚˜, testëŠ” ê³„ì†í•´ì„œ isolateì‹œí‚¤ê³  ì‹¶ê³ , í•œë²ˆì— í•˜ë‚˜ì˜ ëª¨ë¸ë§Œì„ í…ŒìŠ¤íŠ¸í•˜ê³  ì‹¶ë‹¤.

ìƒˆ ê²Œì‹œë¬¼ì„ ë§Œë“œëŠ” í”„ë¡œì„¸ìŠ¤ë¥¼ ë°”ê¾¸ê¸° ì‰½ê²Œ ë§Œë“¤ì.

 ```ruby
class Blog
    # ...
    attr_writer :post_source
    # ...
    private
    def post_source
        @post_source ||= Post.public_method(:new)
    end
end
 ```

 public_methodëŠ” í˜¸ì¶œê°€ëŠ¥í•œ ë©”ì„œë“œ ê°ì²´ë¥¼ ì¸ìŠ¤í„´ìŠ¤í™” í•œë‹¤. ê°ì²´ì˜ `call` ë©”ì„œë“œê°€ í˜¸ì¶œë˜ë©´, ì›ë˜ ê°ì²´ì—ì„œ ëª…ëª… ëœ ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•œ ê²ƒ ì²˜ëŸ¼ëœë‹¤. `public_method`ì´ë¦„ì—ì„œ `public`ì€ `method`ë¼ê³ ë§Œ ì“°ëŠ” ê²ƒê³¼ëŠ” ë‹¬ë¦¬, public_methodëŠ” publicê³¼ privateì˜ ê²½ê³„ë¥¼ ì¡´ì¤‘í•˜ë©°, private ë©”ì„œë“œë¥¼ ìœ„í•œ Method ê°ì²´ë¥¼ ìƒì„±í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•œë‹¤. 

> `public_method` ì°¸ê³ 
>
> 1. [why-use-rails-public-method](https://stackoverflow.com/questions/15022621/why-use-rails-public-method)

> `tap`ë©”ì„œë“œ ì°¸ê³ 
>
> 1. https://publish.dayone.app/post/1eP1zCQ 
> 2. https://stackoverflow.com/questions/17493080/advantage-of-tap-method-in-ruby

> `call` ë©”ì„œë“œ ì°¸ê³ 
>
> 1. https://stackoverflow.com/questions/35400337/ruby-send-vs-call-method

ì´ ê²½ìš° `Post.public_method`ëŠ” ì•„ì§ ì‘ì„±ë˜ì§€ ì•Šì€ `Post.new ë©”ì„œë“œ`ë¥¼ ë‚˜íƒ€ë‚´ëŠ” `Method`ê°ì²´ì— ëŒ€í•œ ì°¸ì¡°ë¥¼ ê°€ì ¸ì˜¨ë‹¤. ì •ìƒì ì¸ ì‘ë™ ì¤‘ì—, ë¸”ë¡œê·¸ëŠ” post ê°ì²´ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ ì´ ë©”ì„œë“œ ì°¸ì¡°(Post.newì™€ ë™ë“±í•œ)ë¥¼ ì‚¬ìš©í•  ê²ƒì´ë‹¤. ê·¸ëŸ¬ë‚˜, ì´ê²ƒì€ í´ë˜ìŠ¤ë¥¼ í…ŒìŠ¤íŠ¸í•  ë•Œ ëª¨ë“  í˜¸ì¶œê°€ëŠ¥í•œ ê°ì²´ë¡œ ëŒ€ì²´í•  ìˆ˜ ìˆë‹¤.

ì´ì œ, `Blog#new_post`ê°€ ì–´ë–»ê²Œ í–‰ë™í•´ì•¼ í•˜ëŠ”ì§€ì— ëŒ€í•œ assertionsë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤.

```ruby
# spec/models/blog_spec.rb
require 'ostruct'
describe Blog do
    # ...
    describe "#new_post" do
        before do
            @new_post = OpenStruct.new
            @it.post_source = ->{ @new_post }
        end
        it "returns a new post" do
            @it.new_post.must_equal @new_post
        end
        it "sets the post's blog reference to itself" do
            @it.new_post.blog.must_equal(@it)
        end
    end
end
```

> OpenStructë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ostructë¥¼ ì‚¬ìš©í–ˆë‹¤.
>
> - An *OpenStruct* is a data structure, similar to a Hash, that allows the definition of arbitrary attributes with their accompanying values. 
>
>   (https://ruby-doc.org/stdlib-2.7.1/libdoc/ostruct/rdoc/OpenStruct.html)
>
> `@it.new_post`ëŠ” `@new_post`ì™€ ê°™ì•„ì•¼ í•œë‹¤. (@itëŠ” Blogì˜ ì¸ìŠ¤í„´ìŠ¤ë‹¤.)
>
> `@it.new_post.blog`ëŠ” `@it`ì™€ ê°™ì•„ì•¼í•œë‹¤.

ì—¬ê¸°ì„œ, post_sourceë©”ì„œë“œ ëŒ€ì‹  `OpenStruct`ë¥¼ ë¦¬í„´í•˜ëŠ” lambdaë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ì´ê²ƒë“¤ì„ í†µê³¼ì‹œí‚¤ëŠ” ê²ƒì€ ê°„ë‹¨í•˜ë‹¤.

```ruby
class Blog
    # ...
    def new_post
        post_source.call.tap do |p|
            p.blog = self
        end
    end
end
```

### Aside: subject and let

ìµœì‹  ë²„ì „ì˜ MiniTestê°€ RSpecì—ì„œ letê³¼ subjectë¥¼ ë©”ì„œë“œë¥¼ ê°€ì ¸ì™”ë‹¤. ëª¨ë“  ì˜ˆì œì— ì ìš©í•˜ì§€ëŠ” ì•Šì§€ë§Œ, ê°„ë‹¨í•˜ê²Œ subjectì™€ letì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ì„œ ë³´ì—¬ì£¼ê² ë‹¤.

blog_spec.rbë¥¼ ê°„ëµí•˜ê²Œ í‘œí˜„í•´ë³´ì•˜ë‹¤.

```ruby
#ì›ë˜ ì½”ë“œ
# spec/models/blog_spec.rb
describe Blog do
    before do
        @it = Blog.new
    end
    it "has no entries" do
        @it.entries.must_be_empty
    end
    #...
end

#subject, let ì‚¬ìš© ì½”ë“œ
describe Blog do
    subject { Blog.new(->{entries}) }
    let(:entries) { [] }
    it "has no entries" do
        subject.entries.must_be_empty
    end
    # ...
end
```

- @itëŠ” subjectë¡œ ë°”ë€Œì—ˆê³  @entriesëŠ” ì´ì œ entriesë¡œ ë°”ë€Œì—ˆë‹¤.
- before ë¸”ë¡ì„ ì œê±°í•˜ëŠ” ê²ƒ ì™¸ì—ë„, letê³¼ subjectëŠ” ë‹¤ë¥¸ ìœ ìš©í•œ ì†ì„±ì„ ê°€ì§€ê³  ìˆë‹¤. ê·¸ê²ƒë“¤ì€ ëŠë¦¬ê²Œ ì¸ìŠ¤í„´ìŠ¤í™”ë˜ê³  ë©”ëª¨ëœë‹¤. ì¦‰, í…ŒìŠ¤íŠ¸ì—ì„œ í•­ëª©ì„ ì „í˜€ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ê°œì²´ê°€ ì¸ìŠ¤í„´ìŠ¤í™”ë˜ì§€ ì•ŠëŠ”ë‹¤. ê·¸ë¦¬ê³ , í…ŒìŠ¤íŠ¸ì—ì„œ í•­ëª©ì„ ë‘ ë²ˆ ì´ìƒ ì°¸ì¡°í•˜ë©´ ì •ì˜ ë¸”ë¡ì´ í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ê³  ë°˜í™˜ë˜ëŠ” ê°’ì´ ì¬ì‚¬ìš©ëœë‹¤. ì‹¤í–‰ì— ë¹„ìš©ì´ ë§ì´ ë“œëŠ” ê°ì²´ë¼ë©´ ìˆ˜í–‰ ì†ë„ê°€ ë¹¨ë¼ ì§ˆ ìˆ˜ ìˆë‹¤.
- letê³¼ subjectì— ì•¡ì„¸ìŠ¤í•˜ë ¤ë©´ gem ë²„ì „ì˜ MiniTest ë˜ëŠ” Ruby 1.9.3ì´ í•„ìš”í•˜ë‹¤.

### Posts vs. Entries

BlogëŠ” entriesë¥¼ ê°€ì§€ê³  ìˆë‹¤ê°€, ì´ì œëŠ” posts ê¹Œì§€ ê°€ì§€ê³  ìˆë‹¤. ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì‚¬ìš©í•˜ë©´ ì•ˆë ê¹Œ?

ì‚¬ì‹¤, ì—¬ëŸ¬ ìš©ì–´ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ì˜ë„ì ì¸ ê²ƒì´ë‹¤. ì˜ˆë¯¼í•œ í”„ë ˆì„ì›Œí¬ ê·œì¹™ì˜ ë‹¨ì ì€ ì–¼ë§ˆ í›„ì— ì´ ê·œì¹™ë“¤ì´ ê°€ì •ìœ¼ë¡œ ë°”ë€ë‹¤ëŠ” ê²ƒì´ë‹¤.ì´ ê²½ìš°, entries ì§‘í•©ì„ postsë¼ê³  ë¶€ë¥¸ë‹¤ë©´, Post í´ë˜ìŠ¤ì™€ ì •ì‹ ì ìœ¼ë¡œ ì—°ê´€ë  ê°€ëŠ¥ì„±ì´ í¬ë‹¤. ê²°êµ­, blog.postsì˜ ëª¨ë“ ê²ƒì€ Post ê°ì²´ì´ë‹¤.

ì´ê²ƒì€ í°ë¬¸ì œë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ë§Œì•½blog.new_postê°€ Post.newì™€ ë™ì¼í•˜ë‹¤ê³  ê°€ì •í•˜ë©´, Blog partë¥¼ ê±´ë„ˆ ë›°ê³  ìƒˆ ë¸”ë¡œê·¸ Entryë¥¼ ì›í•  ë•Œë§ˆë‹¤ Post.new(...) ë˜ëŠ” Post.create(...)ì„ ì¨ì•¼í•  ìˆ˜ ìˆë‹¤.

ì‹œê°„ì´ ì§€ë‚˜ ì‚¬ì§„ì´ë‚˜ ë™ì˜ìƒê³¼ ê°™ì€ë‹¤ë¥¸ í´ë˜ìŠ¤ë¡œ í‘œì‹œë˜ëŠ” ë‹¤ì–‘í•œ ìœ í˜•ì˜ ê²Œì‹œë¬¼ì„ ì¶”ê°€í•œë‹¤ê³  ê°€ì •í•´ë³´ì. Blog.new_post (...)ë¥¼ í˜¸ì¶œí•˜ë©´ ì¸ìˆ˜ë¥¼ë³´ê³  ì¸ìŠ¤í„´ìŠ¤í™” í•  ì˜¬ë°”ë¥¸ ìœ í˜•ì˜ ê°ì²´ë¥¼ ì„ íƒí•  ê²ƒ ì´ë‹¤. ë¶ˆí–‰íˆë„, ìš°ë¦¬ëŠ” ëª¨ë“ ê²ƒì— Postì— ëŒ€í•œ ì°¸ì¡°ë¥¼ í•˜ë“œ ì½”ë”©í–ˆê³  ëª¨ë‘ ë³€ê²½í•´ì•¼í•œë‹¤.

ì´ëŸ° ì¢…ë¥˜ì˜ ê°€ì •ì€ ì¶”ê°€ì ì¸ ì¼ì—ì„œ í•´ë°©ì‹œì¼œ ì¤„ ë¿ë§Œ ì•„ë‹ˆë¼, ë³´ì•ˆ í—ˆì ‘ì„ ë³´ì—¬ì¤„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ë¸”ë¡œê·¸ ì—”íŠ¸ë¦¬ë¥¼ Postsë¡œ ë§Œë“¤ì—ˆë‹¤ê³  ê°€ì •í•´ë³´ë©´, ì•„ë˜ì™€ ê°™ì´ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ì½”ë”©í–ˆì„ ê²ƒ ì´ë‹¤.

```ruby
def update
    @post = Post.find(params[:id])
    # ...
end
```

ê·¸ë¦¬ê³ , ì—¬ëŸ¬ê°œì˜ ë¸”ë¡œê·¸ë¥¼ í˜¸ìŠ¤íŒ…í•˜ëŠ” ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ê¸°ë¡œ ì–´ëŠë‚  ê²°ì •í–ˆë‹¤. ì‹±ê¸€í†¤ ë¸”ë¡œê·¸ ì¸ìŠ¤í„´ìŠ¤ ëŒ€ì‹ ì— ê°ê°ì˜ ë‹¤ë¥¸ ìœ ì €ê°€ ì†Œìœ í•œ ì—¬ëŸ¬ê°œì˜ ë¸”ë¡œê·¸ê°€ ìˆë‹¤. ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” ë¸”ë¡œê·¸ê°€ ì†Œìœ í•œ ìœ ì €ì— ì˜í•´ì„œë§Œ ìˆ˜ì • ë  ìˆ˜ ìˆë„ë¡ ì—…ë°ì´íŠ¸ ë˜ì–´ì•¼í•œë‹¤.

ì—…ê·¸ë ˆì´ë“œëŠ” ì‰½ê³ , ëª¨ë“  ê²ƒì´ ì˜ ì‘ë™í•œë‹¤. ê·¸ëŸ° ë‹¤ìŒ, ì–´ëŠ ë‚  ì˜ë¦¬í•œ ì‚¬ìš©ìëŠ”ë‹¤ë¥¸ ì‚¬ëŒì˜ ê²Œì‹œë¬¼ì˜ IDë¥¼ ì¶”ì¸¡í•  ìˆ˜ ìˆìœ¼ë©° ì»¨í…ì¸ ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŒì„ ì•Œê²Œ ëœë‹¤. ê·¸ ì´ìœ ëŠ” ë¬´ì—‡ì¼ê¹Œ? Post.find()ì— ëŒ€í•œ ëª¨ë“  í˜¸ì¶œì´ ë¸”ë¡œê·¸ ì¸ìŠ¤í„´ìŠ¤ë¡œ ë¶€í„° ê²Œì‹œë¬¼ì— ì•¡ì„¸ìŠ¤í•˜ëŠ” ê²ƒì„ ë¬´ì‹œí•˜ê³  ê²Œì‹œë¬¼ì— ì§ì ‘ ì ‘ê·¼í–ˆê¸° ë•Œë¬¸ì´ë‹¤.

ì´ëŸ°ì¼ë“¤ì€ ì‹¤ì œ í”„ë¡œë•ì…˜ì˜ ì½”ë“œì—ì„œë„ ì¢…ì¢… ë³´ì¸ë‹¤. blog entriesì™€ Post ê°ì²´ì— ëŒ€í•œ ìš©ì–´ë¥¼ ê°ê° ì‚¬ìš©í•œë‹¤ê³  ë¬¸ì œê°€ ìë™ìœ¼ë¡œ í•´ê²°ë˜ëŠ” ê²ƒì€ ì•„ë‹ˆë‹¤. í•˜ì§€ë§Œ, ë‹¤ë¥¸ ìš©ì–´ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ë¸”ë¡œê·¸ì— ì˜í•´ ë§¤ë‹ˆì§• ë˜ëŠ” entriesì™€ Post ë ˆì½”ë“œê°€ ê°™ì§€ ì•Šì•„ë„ ë˜ëŠ” ê²ƒì„ ìƒê¸°ì‹œì¼œì¤€ë‹¤.

ì´ ì±…ì€ Rails í”„ë¡œì íŠ¸ë¥¼ ì‹ ì„ í•œ ê´€ì ì—ì„œ ë°”ë¼ ë³´ëŠ” ê²ƒì´ ëª©ì ì´ë‹¤.

### The Post class

ì´ì œ, Post í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ì•¼ í•œë‹¤ëŠ” ê²ƒì€ ë‹¹ì—°í•˜ë‹¤.

postì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ë¥¼ ì‘ì„±í•œë‹¤.

```ruby
# spec/models/post_spec.rb
require 'minitest/autorun'
require_relative '../../app/models/post'
describe Post do
    before do
        @it = Post.new
    end
    it "starts with blank attributes" do
        @it.title.must_be_nil
        @it.body.must_be_nil
    end
    it "supports reading and writing a title" do
        @it.title = "foo"
        @it.title.must_equal "foo"
    end
    it "supports reading and writing a post body" do
        @it.body = "foo"
        @it.body.must_equal "foo"
    end
    it "supports reading and writing a blog reference" do
        blog = Object.new
        @it.blog = blog
        @it.blog.must_equal blog
    end
    describe "#publish" do
        before do
            @blog = MiniTest::Mock.new
            @it.blog = @blog
        end
        after do
            @blog.verify
        end
        it "adds the post to the blog" do
            @blog.expect :add_entry, nil, [@it]
            @it.publish
        end
    end
end
```

post í…ŒìŠ¤íŠ¸ì— ë§ëŠ” í´ë˜ìŠ¤ë¥¼ ì‘ì„±í•œë‹¤.

```ruby
# app/models/post.rb
class Post
    attr_accessor :blog, :title, :body
    def publish
        blog.add_entry(self)
    end
end
```

### Why â€œpublishâ€?

ì•„ë§ˆ ë ˆì¼ì¦ˆ appì„ ë§Œë“¤ì–´ ë³´ì•˜ë‹¤ë©´, saveë©”ì„œë“œ ëŒ€ì‹  publush ë©”ì„œë“œë¥¼ ë§Œë“ ì´ìœ ê°€ ê¶ê¸ˆí•  ê²ƒì´ë‹¤.

ê°ì²´ ì§€í–¥ ì„¤ê³„ì˜ ì¤‘ì‹¬ ìš”ì†Œ ì¤‘ í•˜ë‚˜ëŠ” ìš°ë¦¬ ëª¨ë¸ì˜ ë„ë©”ì¸ì˜ ì–¸ì–´(ìš©ì–´)ë¥¼ í¬ì°©í•˜ëŠ” ê²ƒì´ë‹¤. ì•„ë¬´ë„ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ë¥¼ ì €ì¥í–ˆë‹¤ê³  í•˜ì§€ ì•ŠëŠ”ë‹¤. ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ë¥¼ publish í–ˆë‹¤ê³  í•˜ëŠ” ê²ƒì´ ë” ì ì ˆí•˜ë‹¤. (â€œI published a blog postâ€ or â€œI posted a blog entryâ€) 

ë¸”ë¡œê·¸ì˜ ê¸°ëŠ¥ì´ í™•ì¥ë˜ì–´, í¬ìŠ¤íŠ¸ë¥¼ ì˜ˆì•½ëœ ì‹œê°„ì— ì˜¬ë ¤ì£¼ëŠ” ê¸°ëŠ¥, ë˜ëŠ” ì´ˆì•ˆê¸°ëŠ¥ ë“±ì„ ì¶”ê°€ í•  ìˆ˜ ìˆë‹¤.

publishë¼ëŠ” ì´ë¦„ì˜ ë©”ì„œë“œë¥¼ ì‚¬ìš©í•¨ìœ¼ë¡œ ì•ìœ¼ë¡œ ì¶”ê°€ë  ê¸°ëŠ¥ë“¤ê³¼ ì°¨ë³„ì„ ë‘˜ ìˆ˜ ìˆë‹¤.

ì ì ˆí•œ ë„ë©”ì¸ ìš©ì–´ë¥¼ ì“°ëŠ” ê²ƒì€ í”„ë¡œê·¸ë¨ì˜ í™•ì¥ì„ ìš©ì´í•˜ê²Œ í•œë‹¤.

### Adding entries to the blog

Postë¥¼ ìƒˆë¡œ ë§Œë“¤ì—ˆê¸° ë•Œë¬¸ì— Blog ëª¨ë¸ì— postë¥¼ ë¸”ë¡œê·¸ì— ì¶”ê°€í•˜ëŠ” í•˜ë‚˜ì˜ ë©”ì„œë“œê°€ ë” í•„ìš”ë¡œ í•´ì¡Œë‹¤. í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì§œê³  ë©”ì„œë“œë¥¼ ì¶”ê°€í•˜ì.

```ruby
describe Blog do
    describe "#add_entry" do
        it "adds the entry to the blog" do
            entry = Object.new
            @it.add_entry(entry)
            @it.entries.must_include(entry)
        end
    end
end
```

```ruby
class Blog
    # ...
    def add_entry(entry)
        entries << entry
    end
    # ...
end
```

BlogControllerì— ìˆëŠ” demo ì½”ë“œë¥¼ ë³´ë©´, ë‘ ë²ˆì§¸ postë¥¼ ë§Œë“¤ ë•Œ, ì•½ê°„ ìˆ˜ì •ì„ í–ˆê³ , titleì„ ì•„ê·œë¨¼íŠ¸ë¡œ ì „ë‹¬í–ˆë‹¤.

```ruby
post2 = @blog.new_post(title: "Still wet")
```

ì´ì œ ` Blog#new_post`ê°€ ì˜ ë™ì‘í•  ìˆ˜ ìˆë„ë¡ ìˆ˜ì •í•˜ì.

ë¨¼ì €, spec í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì¶”ê°€í•˜ì.

>  spec/models/blog_spec.rb

```ruby
it "accepts an attribute hash on behalf of the post maker" do
    post_source = MiniTest::Mock.new
    post_source.expect(:call, @new_post, [{x: 42, y: 'z'}])
    @it.post_source = post_source
    @it.new_post(x: 42, y: 'z')
    post_source.verify
end
```

new_post ë©”ì„œë“œë¥¼ ìˆ˜ì •í•œë‹¤.

> Blog#new_post

```ruby
def new_post(*args)
    post_source.call(*args).tap do |p|
        p.blog = self
    end
end
```

ì´ì œ, ì•„ê·œë¨¼íŠ¸ë¥¼ ì „ë‹¬í•œë‹¤. í•˜ì§€ë§Œ, Post initializerë©”ì„œë“œë¥¼ ì‘ì„±í•´ì•¼ í•œë‹¤.

í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±

> spec/models/post_spec.rb

```ruby
it "supports setting attributes in the initializer" do
    it = Post.new(title: "mytitle", body: "mybody")
    it.title.must_equal "mytitle"
    it.body.must_equal "mybody"
end
```

initailize ì¶”ê°€

```ruby
class Post
    # ...
    def initialize(attrs={})
        attrs.each do |k,v| send("#{k}=",v) end
    end
    # ...
end
```

> ex) `sned("name=", "Jason")` => name = Jason

ì´ì œ postë¥¼ ë³´ì—¬ì£¼ë„ë¡ ë·°ë¥¼ ì—…ë°ì´íŠ¸ í•´ë³´ì.

> index

```erb
<!-- app/views/blog/index.html.erb -->
<h1><%= @blog.title %></h1>
<h2><%= @blog.subtitle %></h2>
<%= render partial: "entry", collection: @blog.entries %>
```

> render partialì„ ì´ìš©í•´ ë°˜ë³µë˜ëŠ” ë¶€ë¶„ì„ ì‰½ê²Œ í‘œí˜„í•  ìˆ˜ ìˆë‹¤.

> _entry

```erb
<!-- app/views/blog/_entry.html.erb -->
<article>
<header>
    <h3><%= entry.title %></h3>
</header>
    <p><%= entry.body %></p>
</article>
```

> íŒŒì¼ëª… ì•ì— `_`ë¥¼ ë¶™ì´ë©´ render partial:ì— ì‚¬ìš©ëœë‹¤.

## 3. Submitting posts

static ì—”íŠ¸ë¦¬ë¡œ êµ¬ì„±ëœ ë¸”ë¡œê·¸ëŠ” ì œí•œì ì´ë‹¤. ìƒˆë¡œìš´ ì—”íŠ¸ë¦¬ë¥¼ ì¶”ê°€í•˜ëŠ” ê¸°ëŠ¥ì„ ë§Œë“¤ì–´ ë³´ì.

ë¨¼ì € `New post` ë²„íŠ¼ì„ ë§Œë“¤ì.

```erb
<!-- app/views/layouts/application.html.erb -->
<!-- ... -->
<div class="sidebar two columns">
    <nav>
        <ul>
            <li><%= link_to "New post...", new_post_path %></li>
        </ul>
    </nav>
</div>
<!-- ... -->
```

`new_post_path`ë¥¼ ì¶”ê°€í•˜ê¸° ìœ„í•´ ì•„ë˜ë¥¼ routes.rb

```ruby
resources :posts
```

> resources
> | HTTP METHOD | PATH            | ACTION  | USED FOR                                           |
> | :---------- | :-------------- | :------ | :------------------------------------------------- |
> | GET         | /posts          | index   | ëª¨ë“  í¬ìŠ¤íŠ¸ë¥¼ë³´ì—¬ì¤ë‹ˆë‹¤.                           |
> | GET         | /posts/new      | new     | ìƒˆë¡œìš´ í¬ìŠ¤íŠ¸ë¥¼ë“±ë¡í•˜ê¸° ìœ„í•œ HTML í¼ì„ ë³´ì—¬ì¤ë‹ˆë‹¤. |
> | POST        | /posts          | create  | ìƒˆë¡œìš´ í¬ìŠ¤íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.                        |
> | GET         | /posts/:id      | show    | íŠ¹ì • í•œê°œì˜ í¬ìŠ¤íŠ¸ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.                   |
> | GET         | /posts/:id/edit | edit    | í¬ìŠ¤íŠ¸ ì •ë³´ë¥¼ ìˆ˜ì •í•˜ê¸° ìœ„í•œ HTML í¼ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.  |
> | PATCH/PUT   | /posts/:id      | update  | í¬ìŠ¤íŠ¸ ì •ë³´ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.                          |
> | DELETE      | /posts/:id      | destroy | íŠ¹ì • í¬ìŠ¤íŠ¸ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.                          |

ë¼ìš°íŠ¸ë¥¼ ìœ„í•œ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ í•„ìš”í•˜ë‹¤.

`rails generate controller Posts`

```ruby
class PostsController < ApplicationController
    def new
        @post = @blog.new_post
    end
end
```

@blog ê°ì²´ê°€ PostsControllerì™€ BolgController ëª¨ë‘ì— í•„ìš”í•œ ê²ƒ ì²˜ëŸ¼ ë³´ì¸ë‹¤. ê³µí†µëœ ë¶€ë¶„ì„ `ApplicationController`ìœ¼ë¡œ ì´ë™ì‹œì¼œ ë³´ì.

```ruby
# app/controllers/application_controller.rb
class ApplicationController < ActionController::Base
    # ...
    before_filter :init_blog
    private
    def init_blog
        @blog = Blog.new
    end
end
```

ë§í¬ë¥¼ ë Œë”ë§ í•˜ëŠ” ê²ƒì€ ëë‚¬ë‹¤. ì´ì œ, new post í¼ì„ ë§Œë“¤ì–´ ë³´ì.

```ruby
<!-- app/views/posts/new.html.erb -->
<h1>New Post</h1>
<%= form_for @post do |f| %>
    <%= f.text_field :title %>
    <%= f.text_area :body %>
    <%= f.submit %>
<% end %>
```

### Using ActiveModel

pathë¥¼ êµ¬ì„±í•˜ê³ , formì€ ë Œë”ë§í•˜ê¸° ìœ„í•´ì„œëŠ”, ë ˆì¼ì¦ˆëŠ” ëª¨ë¸ ê°ì²´ê°€ ë°˜ì‘í•  í”„ë¡œí† ì½œì„ ê¸°ëŒ€í•œë‹¤. ì´ í”„ë¡œí† ì½œì„ ì¤€ìˆ˜í•˜ë„ë¡ í•˜ëŠ” ê°€ì¥ ì‰¬ìš´ ë°©ë²•ì€ ì•¡í‹°ë¸Œëª¨ë¸ì—ì„œ ë‘ ê°œì˜ ëª¨ë“ˆì„ ì¶”ê°€í•˜ëŠ” ê²ƒì´ë‹¤. ë˜í•œ `persisted?`ë¥¼ ë§Œë“¤ì—ˆëŠ”ë°, í˜„ì¬ëŠ” ë‹¨ìˆœíˆ falseë¥¼ ë¦¬í„´í•˜ë„ë¡ í•˜ì.

```ruby
class Post
    extend ActiveModel::Naming
    include ActiveModel::Conversion
    # ...
    def persisted?
        false
    end
    # ...
end
```

ì´ì œ `New post...` ë§í¬ë¥¼ í´ë¦­í•˜ë©´ ìƒˆë¡œìš´ post í¼ì„ ë³¼ ìˆ˜ ìˆë‹¤.

### The Post creation action

ì´ì œ submití•˜ëŠ” ê¸°ëŠ¥ì„ êµ¬í˜„í•´ë³´ì.

PostsControllerì— create ë©”ì„œë“œë¥¼ ì¶”ê°€í•˜ì. ( `PostsController#create`)

```ruby
class PostsController
    # ...
    def create
        @post = @blog.new_post(params[:post])
        @post.publish
        redirect_to root_path, notice: "Post added!"
    end
    # ...
end
```

ì´ì œ, BlogControllerì—ì„œ demo postsë¥¼ ì§€ì›Œë„ ëœë‹¤.

```ruby
class BlogController < ApplicationController
    def index
    end
end
```

### Making the Blog object into a Singleton

postë¥¼ ì¶”ê°€í•´ë„ ê³„ì†í•´ì„œ ìƒˆë¡œìš´ blog ê°ì²´ë¥¼ ìƒì„±í•˜ê¸° ë•Œë¬¸ì— postê°€ ì—†ëŠ” ë¸”ë¡œê·¸ë§Œ ë³´ì´ê²Œ ëœë‹¤. í•˜ë‚˜ì˜ ë¸”ë¡œê·¸ ê°ì²´ë¥¼ ìœ ì§€í•˜ë„ë¡ ë§Œë“¤ì–´ì•¼ í•œë‹¤.

ì–´í”Œë¦¬ì¼€ì´ì…˜ì€ í˜„ì¬ í•˜ë‚˜ì˜ ë¸”ë¡œê·¸ë§Œ ì§€ì›í•  ê²ƒì´ë‹¤. ê·¸ë ‡ê¸° ë•Œë¬¸ì— ì•± ì „ì²´ì— ì‘ìš©í•˜ëŠ” í•˜ë‚˜ì˜ Blog ê°ì²´ë¥¼ initializerë¥¼ ì´ìš©í•˜ì—¬ ì €ì¥í•œë‹¤.

```ruby
# config/initializers/blog.rb 
THE_BLOG = Blog.new
```

ì´ì œ, ApplicationControllerì„ ë‹¤ì‹œ ìˆ˜ì •í•œë‹¤.

```ruby
class ApplicationController < ActionController::Base
    # ...
    def init_blog
        @blog = THE_BLOG
    end
end
```

ìƒˆë¡œìš´ í¬ìŠ¤íŠ¸ë¥¼ submit í•´ë³´ì.

###  Object Trees and Lone Wolves

PostsControllerì—ì„œ ì•„ë˜ createë©”ì„œë“œë¥¼ ì‘ì„±í–ˆì—ˆë‹¤.

```ruby
def create
    @post = @blog.new_post(params[:post])
    @post.publish
    redirect_to root_path, notice: "Post added!"
end
```

ì´ ì•¡ì…˜ì—ì„œ Post í´ë˜ìŠ¤ì— ëŒ€í•œ ì§ì ‘ì ì¸ ì°¸ì¡°ê°€ ì—†ë‹¤. Postsì™€ Entriesì˜ ì°¨ì´ë¥¼ ì´ë¯¸ ì–¸ê¸‰í–ˆì§€ë§Œ ì´ê²ƒì„ í•œ ê°€ì§€ ê´€ì ì—ì„œ ë” ë³´ê³ ì‹¶ë‹¤.

ê°ì²´ì§€í–¥ í”„ë¡œê·¸ë˜ë°ì€ ë‚˜ë¬´ Tree êµ¬ì¡°ë¡œ ì§„í™”í•˜ëŠ” ê²½í–¥ì´ ìˆë‹¤. ì›¹ì‚¬ì´íŠ¸ì—ëŠ” ë¸”ë¡œê·¸ê°€ ìˆê³ , ë¸”ë¡œê·¸ì—ëŠ” ì¹´í…Œê³ ë¦¬ê°€ ìˆê³ , ì¹´í…Œê³ ë¦¬ì—ëŠ” ì—”íŠ¸ë¦¬ê°€ ìˆê³ , ì—”íŠ¸ë¦¬ì—ëŠ” íƒœê·¸ì™€ ì£¼ì„ì´ ìˆë‹¤.

OOPì˜ ë¬¸ì œëŠ” ëŒ€ë¶€ë¶„ì˜ ë³µì¡í•œ ì‹œìŠ¤í…œì€ í•˜ë‚˜ì˜ ìì—°ìŠ¤ëŸ¬ìš´ê³„ì¸µêµ¬ì¡°ë¥¼ ê°€ì§€ê³  ìˆì§€ ì•Šë‹¤ëŠ” ì ì´ë‹¤. ë¸”ë¡œê·¸ ì˜ˆì‹œë¥¼ ì´ìš©í•˜ë©´, ë¸”ë¡œê·¸ëŠ” ì‘ê°€ê°€ ìˆê³ , ê°ê°€ëŠ” ì—”íŠ¸ë¦¬ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©°, ì—”íŠ¸ë¦¬ëŠ” ê·¸ì™€ ê´€ë ¨ëœ ì¹´í…Œê³ ë¦¬ë¥¼ ê°€ì§€ê³  ìˆì„ ìˆ˜ ìˆë‹¤. ì´ê²ƒì€ ë²”ì£¼ê°€ ì—”íŠ¸ë¦¬ë¥¼ í¬í•¨í•˜ëŠ” ê²ƒë³´ë‹¤ ë” ì •í™•í•˜ì§€ ì•Šë‹¤.

ê·¸ëŸ¬ë‚˜ ìš”ì ì€ ìš°ë¦¬ê°€ ìì—°ì ìœ¼ë¡œìš°ë¦¬ì˜ ì‹œìŠ¤í…œì„ ê³„ì¸µ êµ¬ì¡°ë¡œ ì„¸ë¶„í™” í•œë‹¤ëŠ” ê²ƒì´ê³ ,ì´ê²ƒì€ ì‚¬ì‹¤ ê°ì²´ë“¤ì˜ treeë¥¼ ì˜ë¯¸í•œë‹¤. Object Treeì—ì„œ, ê° ê°ì²´ëŠ” ê°ì²´ì˜ ìì´ë‚˜ ê°€ì§€ì— ëŒ€í•œ ì ‘ê·¼ì„ ì¤‘ì¬í•œë‹¤. site ê°ì²´ë¡œë¶€í„°, ë¸”ë¡œê·¸ê°ì²´ì— ì ‘ê·¼í•  ìˆ˜ ìˆê³ , ë¸”ë¡œê·¸ ê°ì²´ë¡œ ë¶€í„° ì¹´í…Œê³ ë¦¬ ê°ì²´ì— ì ‘ê·¼í•  ìˆ˜ ìˆê³ , ì¹´í…Œê³ ë¦¬ ê°ì²´ë¡œë¶€í„°, ì•„í‹°í´ ê°ì²´ì— ì ‘ê·¼ í•  ìˆ˜ ìˆë‹¤.

(ì—¬ê¸°ì„œ ë§í•˜ëŠ” Tree êµ¬ì¡°ëŠ” has-many ë˜ëŠ” belongs-to ê´€ê³„ë¥¼ ë§í•˜ëŠ”ê²ƒì´ì§€, is-aì˜ ìƒì† ê´€ê³„ë¥¼ ë§í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë‹¤.)

ì´ íŒ¨í„´ì€ ëª‡ ê°€ì§€ ë§¤ë ¥ì ì¸ ì„±ì§ˆì„ ê°€ì§€ê³  ìˆë‹¤. ë¶€ëª¨ ê°ì²´ê°€ ìì‹ ê°ì²´ë¡œì˜ ì ‘ê·¼ì„ ì¤‘ì¬í•˜ëŠ” ê²ƒì€ ë””ìì¸ì— ìì—°ìŠ¤ëŸ¬ìš´ ì¸µ(ê²½ê³„ì„ )ì„ ì¤€ë‹¤.

1. (*Posts vs Entriesì—ì„œ ë³¸ ê²ƒê³¼ ê°™ì´) ê¶Œí•œ ì •ë³´ì— ê¸°ë°˜í•œ ì ‘ê·¼ ì œì–´
2. ë¶€ëª¨ì— ëŒ€í•œ ì°¸ì¡°ë¥¼ ì‚¬ìš©í•˜ì—¬ ìì‹ ê°ì²´ê°€ ì¤€ë¹„ë˜ê²Œ í•  ìˆ˜ ìˆë‹¤. #new_postì—ì„œ ë°©ì‹ì„ ì´ìš©í•˜ì—¬ í¬ìŠ¤íŠ¸ê°ì²´ê°€ ìŠ¤ìŠ¤ë¡œ publish í•  ìˆ˜ ìˆë„ë¡ í•˜ì˜€ë‹¤.
3. ìì‹ê°ì²´ì—ëŒ€í•œ ì°¸ì¡°ë¥¼ ë¶€ëª¨ì— ì €ì¥í•œë‹¤. ActiveRecord's autosave facilityëŠ” ìƒìœ„ ê°ì²´ì—ì„œ í•˜ìœ„ ê°ì²´ì— ì•¡ì„¸ìŠ¤í•˜ëŠ” ë° ì¡°ì‹¬í•´ì•¼ í•  ë•Œ, ìƒìœ„ ê°ì²´ê°€ ì €ì¥ë˜ì–´ ìˆë‹¤ë©´ ì•¡í‹°ë¸Œë ˆì½”ë“œëŠ” ìƒì„±, ìˆ˜ì •, ì‚­ì œëœ ìì‹ ê°ì²´ë¥¼ ìë™ìœ¼ë¡œ ìœ ì§€í•  ìˆ˜ ìˆë‹¤.
4. ë¶€ëª¨ì˜ ìƒíƒœë‚˜ íŒŒë¼ë¯¸í„°ì— ê¸°ë°˜í•˜ì—¬, ì¸ìŠ¤í„´ìŠ¤í™”í•  ê°ì²´ì˜ ì‹¤ì œ í´ë˜ìŠ¤ë¥¼ ê²°ì •í•œë‹¤.

ê·¸ë¦¬ê³  ì¸µì´ ìˆëŠ” ê²ƒì˜ ê°€ì¥ ì¢‹ì€ ì ì€ ì´ëŸ¬í•œ ê±±ì •ì„ ì‹œì‘ë¶€í„° í•  í•„ìš”ê°€ ì—†ë‹¤ëŠ” ê²ƒì´ë‹¤. í•„ìš”í•œ ì‹œì ì—ì„œ ê·¸ê²ƒë“¤ì„ ê°„ë‹¨í•˜ê²Œ ì¶”ê°€í•  ìˆ˜ ìˆë‹¤.

ìš°ë¦¬ê°€ í´ë˜ìŠ¤ì˜ ë¶€ëª¨ë¥¼ í†µí•´ ê°ì²´ë¥¼ ë§Œë“¤ê±°ë‚˜ ì ‘ê·¼í•˜ì§€ ì•Šê³ , í´ë˜ìŠ¤ì— ëŒ€í•œ ëª…ì‹œì ì¸ ì°¸ì¡°ë¥¼ ë„£ì„ ë•Œë§ˆë‹¤, ìš°ë¦¬ë“¤ì€ ì—¬ëŸ¬ ì´ì ë“¤ì€ ì•”ë¬µì ìœ¼ë¡œ ê±°ë¶€í•˜ê³  ìˆëŠ” ê²ƒì´ë‹¤.

ê²‰ë³´ê¸°ì— ê²°ì ì´ ì—†ì–´ ë³´ì´ëŠ” ì½”ë“œë¥¼ ì‚´í´ë³´ì.

```ruby
@post = Post.new(params[:post])
@post = Post.create(params[:post])
@post = Post.find(params[:id])
```

ìœ„ ì½”ë“œëŠ”ëª¨ë‘ lone wolfì¸ ê°ì²´ë¥¼ ë§Œë“ ë‹¤. ê°€ì¡±ë„, ì‚¬íšŒë„ ì—†ëŠ” ê°ì²´ì´ë‹¤. ì´ ê°ì²´ëŠ” ìì‹ ë³´ë‹¤ í° ê²ƒì˜ ì¼ë¶€ê°€ ë  ìˆ˜ ì—†ëŠ” ê°ì²´ì´ë‹¤.

ê·¸ë¦¬ê³ , ì´ê²ƒì€ í…ŒìŠ¤íŠ¸ë¥¼ ë” ì–´ë µê²Œ ë§Œë“ ë‹¤.

```ruby
# RSpec
post = stub(:post)
Post.stub(:new).and_return(:post)

Or:

# Mocha
Post.any_instance_stubs(:foo)
```

ì´ ì½”ë“œë“¤ì€ ë‹¨ì§€ ì¶”ê°€ì ì¸ ì¼ê³¼ ì†ŒìŒì„ í…ŒìŠ¤íŠ¸ì— ë”í•  ë¿ ì´ë‹¤. ê°ì²´ì˜ ëª¨ë“  ì¸ìŠ¤í„´ìŠ¤ê°€ stub #newë¥¼ ê°€ì§€ê±°ë‚˜ ë©”ì„œë“œë¥¼ ì˜¤ë²„ë¼ì´ë“œ í•˜ëŠ”ê²ƒì€ í—ˆìš¸ë¿ì¸ ì‚°íƒ„ì´ì˜ ì ‘ê·¼ì´ë‹¤. ê·¸ë¦¬ê³  ê·¸ê²ƒì€ ì™¸ë¡œìš´ ëŠ‘ëŒ€ ê°ì²´ì˜ ìƒì„±ì˜ ê²°ê³¼ë¡œ í•„ìš”í•˜ê²Œ ëœë‹¤.

ì¸µì€ ì„±ì¥í•˜ëŠ” í”„ë¡œê·¸ë¨ì—ì„œ ìœ ìš©í•˜ë‹¤. ì´ê²ƒì„ ê±°ë¶€í•˜ëŠ” ê²ƒì€ ë³´ì•ˆê³¼ ì •í™•ì„± ë¿ë§Œ ì•„ë‹ˆë¼, í™•ì¥ì„±ì—ì„œ ì‹¬ê°í•œ ì˜í–¥ì„ ë¯¸ì¹œë‹¤. ê·¸ë ‡ê¸° ë•Œë¬¸ì— íŠ¹íˆ ë ˆì¼ì¦ˆì˜ ì»¨íŠ¸ë¡¤ëŸ¬ ì•¡ì…˜ì—ì„œ, í´ë˜ìŠ¤ì— ëŒ€í•œ bare referenceëŠ” ë ˆë“œ í”Œë˜ê·¸ë¡œ ê°„ì£¼ëœë‹¤. ì¤„ê¸°ì—ì„œ í°ê°€ì§€ë¡œ, í°ê°€ì§€ì—ì„œ ì‘ì€ê°€ì§€ë¡œ, ì‘ì€ê°€ì§€ì—ì„œ ë” ì‘ì€ ê°€ì§€ë¡œ, ë” ì‘ì€ ê°€ì§€ì—ì„œ ììœ¼ë¡œ ê°€ëŠ” êµ¬ì¡°ì˜ íŠ¸ë¦¬ êµ¬ì¡°ë¥¼ ë³¼ ë•Œ í¸ì•ˆí•¨ì„ ëŠë‚€ë‹¤.

## 4. Getting the tests running again

Post ëª¨ë¸ì„ ë³€ê²½í•˜ì—¬, Testë¥¼ ìˆ˜ì •í•´ì•¼ í•œë‹¤. ìš°ë¦¬ì˜ ì˜ ë¶„ë¦¬ëœ í…ŒìŠ¤íŠ¸ëŠ” ActiveModelì´ ì–´ë””ì— ìˆëŠ”ì§€ ëª¨ë¥¸ë‹¤. 

í…ŒìŠ¤íŠ¸ ì…‹ì—… ê³¼ì •ì—ì„œ ActiveModelì„ requireí•´ì£¼ì–´ì•¼ í•œë‹¤. ê·¸ëŸ¬ë‚˜, ì‚¬ì‹¤ í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í•˜ê¸° ìœ„í•´ ActiveModelì´ í•„ìš”í•˜ì§€ ì•Šê³ , ìš°ë¦¬ëŠ” ì–¼ë§ˆë‚˜ í…ŒìŠ¤íŠ¸ê°€ ì ì€ ì˜ì¡´ì„±ìœ¼ë¡œ ë¹ ë¥´ê²Œ ì‹¤í–‰ë˜ëŠ”ì§€ì— ê´€ì‹¬ì´ ìˆë‹¤. ëª¨ë¸ì˜ í–‰ë™ë“¤ì„ í…ŒìŠ¤íŠ¸í•˜ë©´ì„œ ëª¨ë¸ì„ ê°€ëŠ¥í•œ ê°€ë³ê²Œ ìœ ì§€í•˜ëŠ” ë°©ë²•ê³¼, ì–´í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¶€ë¶„ì„ ì‹¤í–‰í•  ë•Œ ActiveModelê³¼ ê°™ì€ ì˜ì¡´ì„±ë§Œì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì´ ìˆëŠ”ì§€ ì•Œì•„ë³´ì. 

ì´ ë¬¸ì œì—ëŒ€í•œ ì²«ë²ˆì§¸ í‹ˆì€ í…ŒìŠ¤íŠ¸ íŒŒì¼ì—ì„œ post.rbë¥¼ requireí•˜ê¸° ì „ì—, í•„ìš”í•œ ëª¨ë“ˆì„ ë¹„ì–´ìˆëŠ” ë²„ì „ìœ¼ë¡œ ê°„ë‹¨í•˜ê²Œ ì •ì˜í•˜ëŠ” ê²ƒì´ë‹¤.

```ruby
# spec/models/post_spec.rb
# ...
module ActiveModel
    module Naming; end
    module Conversion; end
end
require_relative '../../app/models/post'
# ...
```

> Ghost module

í…ŒìŠ¤íŠ¸ëŠ” í†µê³¼í•˜ì§€ë§Œ, ì´ëŸ¬í•œ ì ‘ê·¼ì€ ë¬¸ì œê°€ ìˆë‹¤. ì´ í…ŒìŠ¤íŠ¸ê°€ full-stack í…ŒìŠ¤íŠ¸ë¥¼ í¬í•¨í•˜ëŠ” Rake taskì˜ ì¼ë¶€ë¡œ ë™ì‘í•˜ê³  ìˆë‹¤ê³  ê°€ì •í•´ ë³´ì. ì „ì²´ë ˆì¼ì¦ˆ í™˜ê²½ì´ ë¡œë“œë  ê²ƒì´ê³ , ë¡œë“œì˜ ìˆœì„œì—ë”°ë¼, ActiveModel::Naming and ActiveModel::Conversionì˜ ë¹„ì–´ìˆëŠ” íŒŒì¼ì´ ActiveSupportê°€ ì´ë¯¸ ì´ ëª¨ë“ˆë“¤ì´ ë¡œë“œ ëë‹¤ê³  ìƒê°í•˜ê²Œ ë§Œë“ ë‹¤. ê·¸ë ‡ê¸° ë•Œë¬¸ì— ì§„ì§œ ë²„ì „ì€ ë¡œë“œë˜ì§€ ì•ŠëŠ”ë‹¤. ì´ê²ƒì€ ë¬¸ì œê°€ ëœë‹¤.

### Stubbing out modules

ë§Œì•½ ëª¨ë“ˆë“¤ì´ ì´ë¯¸ ì •ì˜ë˜ì–´ ìˆì§€ ì•Šê³  ìë™ë¡œë“œë˜ì§€ ì•ŠëŠ” ê²½ìš°, ìš°ë¦¬ì—ê²Œ í•„ìš”í•œ ê²ƒì€ ì¡°ê±´ì ìœ¼ë¡œ empt ì´ë¯¸ ì •ì˜ë˜ì–´ ìˆì§€ ì•Šê³  ìë™ë¡œë“œë˜ì§€ ì•ŠëŠ” ê²½ìš°, ìš°ë¦¬ì—ê²Œ í•„ìš”í•œ ê²ƒì€ ì¡°ê±´ì ìœ¼ë¡œ emptyëª¨ë“ˆì´ë‚˜ `stub` ëª¨ë“ˆì„ ë§Œë“œëŠ” ë°©ë²•ì´ë‹¤. ì•„ë˜ ê·¸ ì¼ì„ í•´ì£¼ëŠ” í•¨ìˆ˜ê°€ ìˆë‹¤.

```ruby
# spec/spec_helper_lite.rb
def stub_module(full_name)
    full_name.to_s.split(/::/).inject(Object) do |context, name|
        begin
            context.const_get(name)
        rescue NameError
            context.const_set(name, Module.new)
        end
    end
end
```

ì´ ë©”ì„œë“œëŠ” `const_get`ì„ ì‚¬ìš©í•˜ì—¬ ì£¼ì–´ì§„ ëª¨ë“ˆì„ ì°¸ì¡°í•˜ê²Œ í•œë‹¤. ë§Œì•½ ëª¨ë“ˆì´ ì´ë¯¸ ì •ì˜ë˜ì–´ ìˆê±°ë‚˜, const_getì„ í˜¸ì¶œí•˜ëŠ” ê²ƒì´ ëª¨ë“ˆì„ ìë™ìœ¼ë¡œ ë¡œë“œë˜ê²Œ í•œë‹¤ë©´, ì´ ë©”ì„œë“œëŠ” ë”ì´ìƒ ì•„ë¬´ê²ƒë„ ì•„ë‹ˆê²Œ ëœë‹¤. í•˜ì§€ë§Œ, const_getì´ ëª¨ë“ˆì„ ì¼œì§€ ëª»í•˜ë©´, ìµëª…ì˜ ë¹ˆ ëª¨ë“ˆì„ ì •ì˜í•˜ì—¬ placeholderë¡œ ì—­í• í•˜ê²Œ í•œë‹¤.

Post specì—ì„œ, ëª¨ë“ˆì„ stub outí•˜ëŠ”ë° ì‚¬ìš©í•˜ê³  ìˆë‹¤.

```ruby
# ...
require_relative '../spec_helper_lite'
stub_module 'ActiveModel::Conversion'
stub_module 'ActiveModel::Naming'
require_relative '../../app/models/post'
# ...
```

## 5. Adding timestamps

íƒ€ì„ìŠ¤íƒ¬í”„ì™€ ìµœê·¼ì˜ í¬ìŠ¤íŠ¸ê°€ ë¨¼ì €ë³´ì´ë„ë¡ ë¦¬ìŠ¤íŒ… í•˜ëŠ” ê²ƒì´ í•„ìš”í•˜ë‹¤. ì´ì œ ì´ê²ƒì„ ì¶”ê°€í•´ ë³´ì.

ì™¸ë¶€ì—ì„œ ì•ˆìœ¼ë¡œ ì ‘ê·¼í•˜ê³ , íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ìœ„ì¹˜ ì‹œí‚¬ ê³³ì„ ë·°ì—ì„œ ë¨¼ì € ì°¾ì„ ê²ƒì´ë‹¤.

```erb
<!-- app/views/blog/_entry.html.erb -->
<article>
    <header>
        <p><time pubdate="pubdate"><%= entry.pubdate %></time></p>
        <h3><%= entry.title %></h3>
    </header>
    <p><%= entry.body %></p>
</article>
```

ì—”íŠ¸ë¦¬ì˜ publishing timestampëŠ” ë¹ˆì¹¸ìœ¼ë¡œ ì‹œì‘ë˜ì–´ publishë˜ë©´ ì±„ì›Œì§ˆ ê²ƒ ì´ë‹¤.

í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•´ë³´ì.

```ruby
# ...
describe "#pubdate" do
    describe "before publishing" do
        it "is blank" do
            @it.pubdate.must_be_nil
        end
    end
    describe "after publishing" do
        before do
            @it.blog = stub!
            @it.publish
        end
        it "is a datetime" do
            @it.pubdate.class.must_equal(DateTime)
        end
    end
end
# ...
```

`stub`ì˜ ì‚¬ìš©ì„ ì£¼ëª©í•˜ë¼. MiniTestì˜ ë¹ŒíŠ¸ì¸ mockingì€ ìš°ë¦¬ì— í•„ìš”ë¥¼ ì¶©ì¡±ì‹œí‚¤ì§€ ëª»í•˜ê¸° ë•Œë¬¸ì—, ê°„ê²°í•˜ì§€ë§Œ ê°•ë ¥í•œ í…ŒìŠ¤íŠ¸ ë”ë¸” ë¼ì´ë¸ŒëŸ¬ë¦¬ì¸ rrë¡œ ë³´ì™„í–ˆë‹¤.

ì…‹ì—…ì„ í•œë‹¤.

```ruby
# spec/spec_helper_lite.rb
require 'rr'
class MiniTest::Unit::TestCase
    include RR::Adapters::MiniTest
end
```

Gemfileì— rrì„ ì¶”ê°€í•œë‹¤.

```ruby
# Gemfile
# ...
group :development, :test do
    # ...
    gem 'rr'
    # ...
end
# ...
```

`pubdate`ë©”ì„œë“œë¥¼ attribute accessorì— ì¶”ê°€í•˜ì.

```ruby
class Post
    attr_accessor :blog, :title, :body, :pubdate
    # ...
```

í˜„ì¬ ì‹œê°„ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ specì— í…ŒìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•˜ì.

```ruby
# ...
describe "#pubdate" do
    # ...
    describe "after publishing" do
        before do
            @clock = stub!
            @now = DateTime.parse("2011-09-11T02:56")
            stub(@clock).now(){@now}
            @it.blog = stub!
            @it.publish(@clock)
        end
        # ...
        it "is the current time" do
            @it.pubdate.must_equal(@now)
        end
    end
end
# ...
```

í…ŒìŠ¤íŠ¸ê°€ ë³µì¡í•˜ë‹¤. ìš°ë¦¬ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ë¦¬íŒ©í† ë§ í•˜ê³ ì‹¶ë‹¤.

stubbled blogì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ëŠ” ê²ƒ ì´ì™¸ì—, @clock stubë¥¼ ìƒì„±í•˜ê³  ìˆë‹¤. 

### Sensible defaults for injected dependencies

ì–´í”Œë¦¬ì¼€ì´ì…˜ì€ í•­ìƒ clock ê°ì²´ë¥¼ Post#publishë¡œ ì „ë‹¬í•´ì£¼ì–´ì•¼ í• ê¹Œ? ì•„ë¬´ê²ƒë„ publishë¡œ ì „ë‹¬í•˜ì§€ ì•Šì„ë•Œ í…ŒìŠ¤íŠ¸ê°€ ê³ ì¥ë‚˜ì§€ëŠ” ì•Šì„ê¹Œ? 

ì´ë•Œ, default ê°’ì„ ì‚¬ìš©í•´ ì£¼ëŠ” ê²ƒì€ ì¢‹ì€ ë°©ë²•ì´ë‹¤. `Post#publish`ë¥¼ ì—…ë°ì´íŠ¸ í•˜ì.

```ruby
require date

# ...
def publish(clock=DateTime)
    self.pubdate = clock.now
    blog.add_entry(self)
end
# ...
```

clock íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ê°€í–ˆê³ , DateTimeì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •í–ˆë‹¤. ì•„ë¬´ëŸ° íŒŒë¼ë¯¸í„°ê°€ ì—†ì„ ê²½ìš°ì—ëŠ” ì‹œìŠ¤í…œ ì‹œê°„ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •í•œë‹¤.

ì™œ clockì„ ë„˜ê¸°ë„ë¡ ë§Œë“¤ì—ˆì„ê¹Œ? ì§€ê¸ˆê¹Œì§€ í…ŒìŠ¤íŠ¸ëŠ” ì™¸ë¶€ ì˜ì¡´ì„±ìœ¼ë¡œë¶€í„° ì‹œìŠ¤í…œí…ŒìŠ¤íŠ¸(SUT)ë¥¼ ë¶„ë¦¬í•˜ëŠ”ë° ë§¤ìš° ì‹ ì¤‘í–ˆë‹¤. ê·¸ëŸ°ë° ì™œ system clockì—ëŠ” ì˜ˆì™¸ë¥¼ ë‘ëŠ”ê²ƒì¸ê°€? clockê°ì²´ë¥¼ ë„˜ê¹€ìœ¼ë¡œì¨, publishì˜ í–‰ë™ì„ ê²°ì •ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•˜ëŠ” ê²ƒì´ ë§¤ìš° ì‰¬ì›Œì¡Œë‹¤. ë˜í•œ, Timecopê³¼ ê°™ì€ ë¬´ê±°ìš´ ë¼ì´ë¸ŒëŸ¬ë¦¬ì— êµ¬ì• ë°›ì§€ ì•ŠëŠ”ë‹¤. ë‹¤ë¥¸ ì¥ì ë“¤ë„ ìˆì§€ë§Œ, ë‹¤ìŒ ì„¹ì…˜ì—ì„œ ë…¼í•˜ê¸°ë¡œ í•œë‹¤.

## 6. OMG Dependency Injection!

ì‹ ì¤‘í•˜ê²Œ ê²©ë¦¬ëœ í…ŒìŠ¤íŠ¸ë“¤ì„ êµ¬ì„±í•  ë•Œ, ìš°ë¦¬ëŠ” ì˜ì¡´ì„± ì£¼ì…ì„ ë‘ë²ˆ ì‚¬ìš©í–ˆë‹¤. ì²«ì§¸, ìš°ë¦¬ëŠ” ë¸”ë¡œê·¸ ì˜¤ë¸Œì íŠ¸ê°€ ìƒˆë¡œìš´ ì—”íŠ¸ë¦¬ë¥¼ ì–´ë–»ê²Œ ìƒì„±í•˜ëŠ”ì§€ ì „ëµí™”í•˜ê¸° ìœ„í•´ `setter injection`ì„ ì‚¬ìš©í–ˆë‹¤.

```ruby
class Blog
    # ...
    attr_writer :post_source
    # ...
    private
    def post_source
        @post_source ||= Post.public_method(:new)
    end
end
```

ê·¸ë¦¬ê³ , ì–¼ë§ˆì „ì— `parameter injection`ì„ ì‚¬ìš©í•˜ì˜€ë‹¤. 

```ruby
# ...
def publish(clock=DateTime)
    self.pubdate = clock.now
    blog.add_entry(self)
end
# ...
```

ìš”ì¦˜ ì˜ì¡´ì„± ì£¼ì… íŒ¨í„´ì— ëŒ€í•œ ì•ˆì¢‹ì€ ì¸ì‹ì´ ë§ë‹¤. ì•„ë§ˆë„, ê·¸ê²ƒì€ ìë°”ë‚˜ C#ì—ì„œ ë¬´ê±°ìš´ DI í”„ë ˆì„ì›Œí¬ë¥¼ ì‚¬ìš©í•œ ê²½í—˜ì—ì„œ ë¹„ë¡¯ë˜ì—ˆë‹¤ê³  ìƒê°í•œë‹¤. ë³´ë‹¤ì‹œí”¼ ì˜ì¡´ì„± ì£¼ì…ì˜ í•µì‹¬ì€ ì™¸ë¶€ì—ì„œ ê°ì²´ì˜ collaboratorsë¥¼ ë‚´ë¶€ë¡œ ì „ë‹¬í•˜ëŠ” ê²ƒì´ë‹¤. ìš°ë¦¬ê°€ ë°©ê¸ˆ ë³¸ ê²ƒì²˜ëŸ¼, RubyëŠ” ì˜ì¡´ì„±ì„ ì£¼ì…ì„ ì‰½ê²Œ í•  ìˆ˜ ìˆìœ¼ë©°, ë™ì‹œì— ì˜ì¡´ì„±ì— ëŒ€í•œ í•©ë¦¬ì ì¸ ë¹ŒíŠ¸ì¸ ë””í´íŠ¸ë¥¼ ì œê³µí•œë‹¤.

ë‹¨ì¼ ì±…ì„ ì›ì¹™ì— ë”°ë¥´ë©´, í´ë˜ìŠ¤ëŠ” í•˜ë‚˜ì˜ ìˆ˜ì •ë  ì´ìœ ë§Œì„ ê°€ì ¸ì•¼ í•œë‹¤. ì´ ì›ì¹™ì˜ í•µì‹¬ì€ í•˜ë‚˜ì˜ ìƒˆë¡œìš´ ìš”êµ¬ì‚¬í•­ìœ¼ë¡œ ì¸í•´ ë‘˜ ì´ìƒì˜ í´ë˜ìŠ¤ ë˜ëŠ” ëª¨ë“ˆì„ ë³€ê²½í•´ì•¼ í•˜ëŠ” ê²½ìš°, ê·¸ í´ë˜ìŠ¤ë“¤ ì¤‘ ì ì–´ë„ í•˜ë‚˜ëŠ” ë„ˆë¬´ ë§ì€ ì±…ì„ì„ ê°€ì§€ê³  ìˆë‹¤ëŠ” ê²ƒì´ë‹¤.

## 7. Sorting and limiting posts

ì´ì œ timestampë¥¼ postì— ì¶”ê°€í–ˆë‹¤. ì‹œê°„ì˜ ì—­ìˆœìœ¼ë¡œ í¬ìŠ¤íŒ…ëœë‹¤. timestampë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ì„ í•˜ì. í•œ í˜ì´ì§€ì— ìµœëŒ€ 10ê°œì˜ í¬ìŠ¤íŠ¸ë¥¼ ë³´ì—¬ì£¼ì.

> Spec

```ruby
# spec/models/blog_spec.rb
# ...
describe "#entries" do
    def stub_entry_with_date(date)
        OpenStruct.new(pubdate: DateTime.parse(date))
    end
    it "is sorted in reverse-chronological order" do
        oldest = stub_entry_with_date("2011-09-09")
        newest = stub_entry_with_date("2011-09-11")
        middle = stub_entry_with_date("2011-09-10")
        @it.add_entry(oldest)
        @it.add_entry(newest)
        @it.add_entry(middle)
        @it.entries.must_equal([newest, middle, oldest])
    end
    it "is limited to 10 items" do
        10.times do |i|
            @it.add_entry(stub_entry_with_date("2011-09-#{i+1}"))
        end
        oldest = stub_entry_with_date("2011-08-30")
        @it.add_entry(oldest)
        @it.entries.size.must_equal(10)
        @it.entries.wont_include(oldest)
    end
end
# ...
```

ì´ì „ì— ë§Œë“¤ì—ˆë˜ entry ì†ì„±ë“¤ì„ ì§€ìš°ê³ , ì§„ì§œ ë©”ì„œë“œë¡œ ëŒ€ì²´í•œë‹¤.

```ruby
def entries
	@entries.sort_by{|e| e.pubdate}.reverse.take(10)
end
```

ê·¸ë¦¬ê³  add_entryë©”ì„œë“œ ë˜í•œ @entriesë¥¼ ì§ì ‘ ì°¸ì¡°í•˜ë„ë¡ ë°”ê¾¼ë‹¤.

```ruby
def add_entry(entry)
    @entries << entry
end
```

ê·¸ë¦¬ê³  í…ŒìŠ¤íŠ¸ë¥¼ í•˜ë©´ ì‹¤íŒ¨í•˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆëŠ”ë°, #pubdate ë©”ì„œë“œê°€ plain Objectì—ëŠ” ì—†ì–´ì„œ ê·¸ë ‡ë‹¤. Object.newëŒ€ì‹ ì— rr stub ê°ì²´ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

```ruby
describe Blog do
    describe "#add_entry" do
        it "adds the entry to the blog" do
            entry = stub!
            # ...
        end
    end
    # ...
end
```

## 8. Adding validation

ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ë“¤ì€, ìµœì†Œí•œ ì œëª©ì€ ê°€ì§€ê³  ìˆì–´ì•¼ í•œë‹¤. ì´ ì œì•½ì„ ê²€ì¦í•´ë³´ì.

```ruby
# ...
it "is not valid with a blank title" do
    [nil, "", " "].each do |bad_title|
        @it.title = bad_title
        refute @it.valid?
    end
end
it "is valid with a non-blank title" do
    @it.title = "x"
    assert @it.valid?
end
# ...
```

ì—¬ê¸°ì—ì„œëŠ” ì§ì ‘ vaild?ë©”ì„œë“œë¥¼ ì ì—ˆì§€ë§Œ, ë ˆì¼ì¦ˆëŠ” ì‚¬ìš©ì ì¹œí™”ì ì¸ ìœ íš¨ì„± ê²€ì¦ë°©ë²•ì„ ì œê³µí•œë‹¤. ActiveModelì„ ì´ìš©í•˜ì—¬ ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

```ruby
class Post
    # ...
    include ActiveModel::Validations
    validates :title, presence: true
    # ...
end
```

ì´ì œ, ActiveModelì„ ì‚¬ìš©í•˜ì—¬ Railsë¿ë§Œ ì•„ë‹ˆë¼ ìš°ë¦¬ì˜ ê¸°ëŒ€ë¥¼ ë§Œì¡±ì‹œí‚¬ ìˆ˜ ìˆë‹¤. ì´ì œ ë”ì´ìƒ ActiveModelëª¨ë“ˆì„ stub out í•  ìˆ˜ ì—†ê³ , ì§„ì§œë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

post_spec.rbì—ì„œ ì•„ë˜ ë‘ ì¤„ì€ ì‚¬ë¼ì ¸ì•¼ í•œë‹¤.

```ruby
stub_module 'ActiveModel::Conversion'
stub_module 'ActiveModel::Naming'
```

ê·¸ë¦¬ê³ , ActiveModelì„ ëª¨ë¸ íŒŒì¼ì— requrieí•´ì•¼ í•œë‹¤.

`require 'active_model'`

ì „ì œ appì„ ì‘ë™í•  ë•Œ, ì´ê²ƒì€ í•„ìˆ˜ê°€ ì•„ë‹ˆì§€ë§Œ, ë ˆì¼ì¦ˆ ë°–ì˜ í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸ë¥¼ í•˜ê¸°ìœ„í•´ì„œ í•„ìš”í•˜ë‹¤. ëª…ì‹œì ìœ¼ë¡œ ActiveModelì´ í•„ìš”í•˜ë‹¤.

Postí´ë˜ìŠ¤ì— validationì„ ì¶”ê°€í•˜ë©´ì„œ, ìƒˆë¡œìš´ postê°€ ìœ íš¨í•  ë•Œë§Œ publishê°€ ë˜ë„ë¡ ë§Œë“¤ì.

```ruby
# ...
describe "#publish" do
    # ...
    describe "given an invalid post" do
        before do @it.title = nil end
        it "wont add the post to the blog" do
            dont_allow(@blog).add_entry
            @it.publish
        end
        it "returns false" do
            refute(@it.publish)
        end
    end
end
# ...
```

```ruby
class Post
    # ...
    def publish(clock=DateTime)
        return false unless valid?
        self.pubdate = clock.now
        @blog.add_entry(self)
    end
    # ...
end
```

ì´ëŸ° ë³€í™”ë¡œ, ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œëŠ” publishì˜ ë¦¬í„´ê°’ì´ trueì¸ì§€ falseì¸ì§€ì— ë”°ë¼ ë‹¤ë¥¸ í–‰ë™ì„ í•œë‹¤.

```ruby
# ...
def create
    @post = @blog.new_post(params[:post])
    if @post.publish
        redirect_to root_path, notice: "Post added!"
    else
        render "new"
    end
end
# ...
```

## 9. Introducing the Exhibit Pattern

ì‚¬ì§„ì„ ì˜¬ë¦¬ëŠ” ê¸°ëŠ¥ì´ ì—†ëŠ” ë¸”ë¡œê·¸ëŠ” ì—†ë‹¤. ì‚¬ì§„ì˜ URLì„ í¬ìŠ¤íŠ¸í•˜ëŠ” ê¸°ëŠ¥ì„ ì¶”ê°€í•´ ë³´ì.

ë§Œì•½, ì‚¬ì§„ URLì„ ê°€ì§€ê³  ìˆë‹¤ë©´, ë³¸ë¬¸ì€ ì‚¬ì§„ìœ¼ë¡œ ë°”ë€” ê²ƒì´ë‹¤.

ì´ì „ì²˜ëŸ¼ ë·° ë ˆë²¨ì—ì„œ ì‹œì‘í•˜ì—¬ ë‚´ë¡œ ì´ë™í•˜ë©´ì„œ ì‘ì—…í•˜ê³ , ìƒˆë¡œìš´ ê²Œì‹œë¬¼ ì–‘ì‹ì— ê·¸ë¦¼ URL í•„ë“œë¥¼ ì¶”ê°€í•  ê²ƒì´ë‹¤.

```erb
<!-- app/views/posts/new.html.erb -->
<%= form_for @post do |f| %>
# ...
<%= label :image_url, "Picture URL:" %>
<%= f.text_field :image_url %>
# ...
<% end %>
```

ê·¸ë¦¬ê³ , í…ìŠ¤íŠ¸ë§Œ ìˆëŠ” ì—”íŠ¸ë¦¬ì™€, ì‚¬ì§„ ì—”íŠ¸ë¦¬ë¥¼ ìœ„í•œ partialsë¥¼ ë§Œë“ ë‹¤. ì•„ë˜ëŠ” ì‚¬ì§„ ì—”íŠ¸ë¦¬ë¥¼ ìœ„í•œ partialì´ë‹¤.

```erb
<!-- app/posts/_picture_body.html.erb -->
<figure>
    <img src="<%= post.image_url %>"/>
    <figcaption><%= post.body %></figcaption>
<figure/>
```

> HTML5 \<figure> \<figcaption> tags to mark up a picture semantically

image_url ì–´íŠ¸ë¦¬ë·°íŠ¸ë¥¼ Post ëª¨ë¸ì— ì¶”ê°€í•œë‹¤.

`attr_accessor :blog, :title, :body, :image_url, :pubdate`

ì´ì œ í¬ìŠ¤íŠ¸ íƒ€ì…ì— ë”°ë¼ ì–´ë–»ê²Œ ë‹¤ë¥´ê²Œ í™”ë©´ì— ë³´ì—¬ì¤„ì§€ ì„¤ì •í•´ì•¼í•œë‹¤.

```erb
<!-- app/views/blog/_entry.html.erb -->
<!-- ... -->
<% if entry.image_url.present? %>
	<%= render "/posts/picture_body", post: entry %>
<% else %>
	<%= render "posts/text_body", post: entry %>
<% end %>
<!-- ... -->
```

í•˜ì§€ë§Œ, ì´ë ‡ê²Œ í•˜ë©´ ì›Œë‹ì´ ëœ¬ë‹¤. ë·°ì—ì„œ ë¡œì§ì„ ì§œëŠ”ê²ƒì€ ì¢‹ì§€ ì•Šë‹¤. 

ê°ì²´ì§€í–¥ ë””ìì¸ ê´€ì ì—ì„œë„ ì˜ëª» ë˜ì—ˆë‹¤. ê°ì²´ì§€í–¥ì—ì„œëŠ” ê°ì²´ê°€ì›ì´ë¼ë©´ ì›ì„ ê·¸ë¦¬ê³ , ë„¤ëª¨ë¼ë©´ ë„¤ëª¨ë¥¼ ê·¸ë¦´ê²ƒì´ë‹¤. 

ì½”ë“œë¥¼ ì•„ë˜ì™€ ê°™ì´ ë°”ê¾¸ì–´ë³´ì.

```ruby
<!-- app/views/blog/_entry.html.erb -->
<% entry = exhibit(entry, self) %>
<article>
  <header>
    <p><time pubdate="pubdate"><%= entry.pubdate %></time></p>
    <h3><%= entry.title %></h3>
  </header>
  <%= entry.render_body %>
</article>
```

í¬ìŠ¤íŠ¸ì˜íƒ€ì…ì€ ì‚¬ì§„ê³¼ í…ìŠ¤íŠ¸ë‘ê°œì´ê³ , ê°ì²´ì§€í–¥ ì² í•™ì˜ í•µì‹¬ì€ ê°ê°ì˜ ê°œë…ì„ ê°ì²´ë¡œ í‘œí˜„í•œ ê²ƒì´ë‹¤. MVC ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ëª¨ë¸ì€ ëª¨ìŠµì— êµ¬ì• ë°›ì§€ ì•Šê³ , ê·¸ë“¤ì´ ìì‹ ì„ ì–´ë–»ê²Œ ë³´ì—¬ì£¼ëŠ”ì§€ëŠ” ì•Œì§€ ë§ì•„ì•¼ í•œë‹¤. ê·¸ë¦¬ê³  ë·°ì—ëŠ” ë¡œì§ì„ ë„£ê³ ì‹¶ì§€ ì•Šë‹¤. ë·°ì™€ ëª¨ë¸ ì‚¬ì´ì— ì œ 3ì˜ ê°ì²´ê°€ í•„ìš”í•œ ê²ƒ ì²˜ëŸ¼ ë³´ì¸ë‹¤.

### Exhibit A

`Exhibit` objectë¥¼ ì‚¬ìš©í•  ê²ƒì´ë‹¤. ëª¨ë¸ì´ ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³  ì¡°ì‘í•˜ë©°, ë·°ê°€ë°ì´í„°ë¥¼ ë³´ì—¬ì¤€ë‹¤ë©´, Exhibitì€ ë‘˜ ì‚¬ì´ì—ì„œ ì–´ë–¤ í…Œì´í„°ë¥¼ ì–´ë–¤ ìˆœì„œë¡œ ë³´ì—¬ì¤„ì§€ ê²°ì •í•œë‹¤. ê·¸ë¦¬ê³  ëª‡ê°€ì§€ ì¶”ê°€ì ì¸ ëª¨ë¸ì€ ìŠ¤ìŠ¤ë¡œ ì•Œ ìˆ˜ ì—†ëŠ” ì •ë³´ë¥¼ ì œê³µí•œë‹¤.(ì†ŒìŠ¤ì™€ ì—°ê´€ëœ URL ë“±)

`Exhibit` objectëŠ” ì‘í’ˆë“¤ì„ ì „ì‹œí•˜ëŠ” ê²ƒê³¼ ë¹„ìŠ·í•´ì„œ ì´ë¦„ì´ `Exhibit` ì´ë‹¤. í‘œí˜„ë˜ëŠ” ê°ì²´ì˜ ì–´ë– í•œ ê²ƒë„ ëª¨í˜¸í•˜ê²Œ í•˜ì§€ì•Šìœ¼ë©°, ì˜¤íˆë ¤ ê°ì²´ì— ëŒ€í•œ ë©”íƒ€ ì •ë³´ì™€ ë‹¤ë¥¸ ê°ì²´ì™€ì˜ ìƒí˜¸ ì°¸ì¡°ë¥¼ í†µí•´ ê°ì²´ë¥¼ ê°€ì¥ ì˜ í‘œí˜„í•œë‹¤.

ê¸°ìˆ ì ìœ¼ë¡œ, í‘œí˜„í• ëª¨ë¸ì„ end userì—ê²Œ íŠ¹ë³„í•˜ê²Œ ë°ì½”ëœ ìƒíƒœë¡œ ë³´ì—¬ì¤€ë‹¤. 

```ruby
# spec/exhibits/picture_post_exhibit_spec.rb
require_relative '../spec_helper_lite'
require_relative '../../app/exhibits/picture_post_exhibit'
describe PicturePostExhibit do
    before do
        @post = OpenStruct.new(
            title: "TITLE",
            body: "BODY",
            pubdate: "PUBDATE")
        @context = stub!
        @it = PicturePostExhibit.new(@post, @context)
    end
    it "delegates method calls to the post" do
        @it.title.must_equal "TITLE"
        @it.body.must_equal "BODY"
        @it.pubdate.must_equal "PUBDATE"
    end
    it "renders itself with the appropriate partial" do
        mock(@context).render(
            partial: "/posts/picture_body", locals: {post: @it}){
                "THE_HTML"
                }
        @it.render_body.must_equal "THE_HTML"
    end
end
```

postì™€ context ê°ì²´ë¥¼ ìœ„í•´ stubë¥¼ ì‚¬ìš©í–ˆë‹¤. post stubëŠ” Post ì¸ìŠ¤í„´ìŠ¤ë¥¼ ëŒ€ì‹ í•˜ê³ , context stubëŠ” ë·°ê°€ ë Œë”ë§í•  ë ˆì¼ì¦ˆ í…œí”Œë¦¿ ê°ì²´ë¥¼ ëŒ€ì‹ í•œë‹¤. renderë©”ì„œë“œë‚˜ form_forë©”ì„œë“œê°€ë·°ì—ì„œ í˜¸ì¶œí•  ë•Œ, í…œí”Œë¦¿ ì˜¤ë¸Œì ì—ì„œ ê·¸ ë©”ì„œë“œë“¤ì„ í˜¸ì¶œí•œë‹¤.

```ruby
# app/exhibits/picture_post_exhibit.rb
require 'delegate'
class PicturePostExhibit < SimpleDelegator
    def initialize(model, context)
        @context = context
        super(model)
    end
    def render_body
        @context.render(partial: "/posts/picture_body", locals: {post: self})
    end
end
```

app/exhibitsì´ë¼ëŠ” ë””ë ‰í† ë¦¬ë¥¼ ë§Œë“¤ì—ˆë‹¤. ê·¸ë¦¬ê³ , PicturePostExhibit classë¥¼ ë§Œë“¤ì—ˆê³ , ì´ í´ë˜ìŠ¤ëŠ” SimpleDelegatorì„ ìƒì†ë°›ëŠ”ë‹¤. SimpleDelegatorëŠ” ë£¨ë¹„ì€ ìŠ¤íƒ ë‹¤ë“œ ë¼ì´ë¸ŒëŸ¬ë¥´ í´ë˜ìŠ¤ë¡œ ì•„ì£¼ ê°„ë‹¨í•œ ì¼ì„ í•œë‹¤. ëª¨ë“  í˜¸ì¶œì„ ê¸°ë³¸ ê°ì²´ì—ê²Œ ì „ë‹¬í•œë‹¤. ê·¸ ìì²´ë¡œëŠ” ê·¸ë ‡ê²Œ ìœ ìš©í•˜ì§€ ì•Šì§€ë§Œ, .Decorate ê°ì²´ë¥¼ ì •ì˜í•˜ê¸° ìœ„í•œ ê¸°ë°˜ìœ¼ë¡œ ì¨ ë§¤ìš° ìœ ìš©í•˜ë‹¤. exhibit initializerì—ì„œ, ìš°ë¦¬ëŠ” ë·° contextë¥¼ ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ì— ì €ì¥í–ˆë‹¤. ê·¸ í›„, ìš°ë¦¬ëŠ” SimpleDelegator initializerë¥¼ ëª¨ë¸ ê°ì²´ì— ìœ„ì„ì„ í•˜ê¸° ìœ„í•´ superë¥¼ í†µí•´ í˜¸ì¶œí•œë‹¤. #render_body methodì—ì„œ ì €ì¥ëœ @contextë¥¼ ì‚¬ìš©í•˜ì—¬ picture íƒ€ì…ì˜ postë¥¼ ë Œë”ë§í•œë‹¤. í…ìŠ¤íŠ¸ í¬ìŠ¤íŠ¸ë¥¼ ìœ„í•œ exibitë„ ê±°ì˜ë™ì¼í•˜ë‹¤. ê·¸ë ‡ê¸° ë–„ë¬¸ì— specì€ ìƒëµí•˜ë„ë¡ í•˜ê² ë‹¤.

```ruby
# exhibits/text_post_exhibit.rb
require 'delegate'
class TextPostExhibit < SimpleDelegator
    def initialize(model, context)
        @context = context
        super(model)
    end
    def render_body
        @context.render(partial: "/posts/text_body", locals: {post: self})
    end
end
```

ì°¨ì´ì ì€ ë‹¤ë¥¸ partialê°€ ë Œë”ë§ ëœë‹¤ëŠ” ì ì´ë‹¤. ì´ì œ ì ì ˆí•œ exhibitì— ëª¨ë¸ ê°ì²´ë¥¼ ê°ì‹¸ëŠ” ë°©ë²•ì´ í•„ìš”í•˜ë‹¤.

Let's spec out a helper to do that:

```ruby
# spec/helpers/exhibits_helper_spec.rb
require_relative '../spec_helper_lite'
require_relative '../../app/helpers/exhibits_helper'
stub_class 'PicturePostExhibit'
stub_class 'TextPostExhibit'
stub_class 'Post'
describe ExhibitsHelper do
    before do
        @it = Object.new
        @it.extend ExhibitsHelper
        @context = stub!
    end
    it "decorates picture posts with a PicturePostExhibit" do
        post = Post.new
        stub(post).picture?{true}
        @it.exhibit(post, @context).must_be_kind_of(PicturePostExhibit)
    end
    it "decorates text posts with a TextPostExhibit" do
        post = Post.new
        stub(post).picture?{false}
        @it.exhibit(post, @context).must_be_kind_of(TextPostExhibit)
    end
    it "leaves objects it doesn't know about alone" do
        model = Object.new
        @it.exhibit(model, @context).must_be_same_as(model)
    end
end
```

By its nature, ExhibitsHelperëŠ” ì„±ê²©ìƒ ìˆ˜ë§ì€ ëª¨ë¸ í´ë˜ìŠ¤ì™€ exhibit í´ë˜ìŠ¤ë¥¼ ì°¸ì¡°í•˜ëŠ” ì½”ë“œì´ë‹¤. ì´ëŸ° ëª¨ë“  í´ë˜ìŠ¤ë“¤ì—ëŒ€í•œ í…ŒìŠ¤íŠ¸ ì˜ì¡´ì„ í”¼í•˜ê¸° ìœ„í•´, #stub_class test helperë¥¼ ì‚¬ìš©í•œë‹¤. ê·¸ê²ƒì€ ê±°ì˜ #stub_module methodì™€ ê±°ì˜ í¡ì‚¬í•˜ë‹¤. 

Here's helper code which satisfies the spec:

```ruby
# app/helpers/exhibits_helper.rb
module ExhibitsHelper
    def exhibit(model, context)
        # Doing a string comparison because of Rails class-reloading weirdness
        case model.class.name
        when 'Post'
            if model.picture?
                PicturePostExhibit.new(model, context)
            else
                TextPostExhibit.new(model, context)
            end
        else
            model
        end
    end
end
```

ì—¬ì „íˆ ì¡°ê±´ë¬¸ì´ ë‚œì¡í•˜ê²Œ ìˆë‹¤. ë¶ˆí–‰íˆë„, ì´ëŸ¬í•œ ìœ í˜• ê¸°ë°˜ì˜ ì¡°ê±´ë“¤ì€ ì™„ì „íˆ ì œê±°í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•œ ê²ƒì€ ì•„ë‹ˆë‹¤. ìš°ë¦¬ê°€ í•  ìˆ˜ ìˆëŠ” ê²ƒì€ ë·°ì½”ë“œì— ì¡°ê±´ë¬¸ì„ ë„£ê¸°ë³´ë‹¤ëŠ”, ì¡°ê±´ì„ í•œ ê³³ì— ê²©ë¦¬ ì‹œí‚¤ëŠ” ê²ƒì´ë‹¤.  

ìœ„ì— ìˆëŠ” helperì½”ë“œì—ì„œ #picture? ë©”ì„œë“œë¥¼ Postì— ì¶”ê°€í•´ì•¼í•œë‹¤.

Spec:

```ruby
# ...
describe "#picture?" do
    it "is true when the post has a picture URL" do
        @it.image_url = "http://example.org/foo.png"
        assert(@it.picture?)
    end
    it "is false when the post has no picture URL" do
        @it.image_url = ""
        refute(@it.picture?)
    end
end
# ...
```

Implementation:

```ruby
# ...
def picture?
    image_url.present?
end
# ...
```

#exhibit helper methodë¥¼ ë„“ì€ ê³³ì—ì„œ ì‚¬ìš©í•  ì˜ˆì •ì´ê¸° ë•Œë¬¸ì—, ì•„ë˜ ì½”ë“œë¥¼ ApplicationControllerì— ì¶”ê°€í•œë‹¤.

```ruby
class ApplicationController < ActionController::Base
    # ...
    helper :exhibits
    # ...
end
```

ì´ì œ, ìš°ë¦¬ì˜ ì‘ì€ exhibit frameworkê°€ ì™„ì„± ë˜ì—ˆë‹¤. ë¸”ë¡œê·¸ ì—”íŠ¸ë¦¬ë¥¼ ë³´ì—¬ì£¼ëŠ” ì½”ë“œë¥¼ ë‹¤ì‹œ ì‘ì„±í•˜ì.

```ruby
<% entry = exhibit(entry, self) %>
<article>
<header>
    <p><time pubdate="pubdate"><%= entry.pubdate %></time></p>
    <h3><%= entry.title %></h3>
</header>
    <%= entry.render_body %>
</article>
```

No more conditionals in the view! Just a simple method call to #render_body which Does The Right Thing. 

### Refactoring the exhibits

ë§Œë“¤ì—ˆë˜ ë‘ ê°œì˜ exhibitì€ ê±°ì˜ ìœ ì‚¬í•˜ë‹¤. ì´ê²ƒë“¤ì€ ë¦¬íŒ©í† ë§í•˜ê¸°ì— ë§ˆë•…í•˜ë‹¤. ê³µí†µì˜ ë¶€ë¶„ì„ Exhibit base classì— ì‘ì„±í•˜ì—¬ ìƒì†ì„ í•˜ì.

```ruby
# app/exhibits/exhibit.rb
require 'delegate'
class Exhibit < SimpleDelegator
    def initialize(model, context)
        @context = context
        super(model)
    end
end
```

```ruby
require_relative 'exhibit'
class PicturePostExhibit < Exhibit
    def render_body
        @context.render(partial: "/posts/picture_body", locals: {post: self})
    end
end
```

Exhibit base classì— ì¶”ê°€ì ì¸ ì½”ë“œë¥¼ ì‘ì„±í•˜ì.

```ruby
class Exhibit < SimpleDelegator
    # ...
    def to_model
        __getobj__
    end
    def class
        __getobj__.class
    end
end
```

#to_modelì€ wrapped modelì„ ë¦¬í„´í•œë‹¤. (#__getobj__ methodëŠ” SimpleDelegatorê°€ ê¸°ì € ê°ì²´ë¥¼ ì§€ì¹­í•˜ëŠ” ë°©ë²•ì´ë‹¤. ë‘ë²ˆì§¸ #classëŠ” exhibit í´ë˜ìŠ¤ ëŒ€ì‹ ì— ì›ë˜ì˜ ëª¨ë¸ì˜ í´ë˜ìŠ¤ë¥¼ ë¦¬í„´í•˜ê¸° ìœ„í•´ ì¬ì •ì˜ëë‹¤. ì´ ë©”ì„œë“œë“¤ì´  #form_forì™€ ê°™ì€ rails helperê°€ exhibitìœ¼ë¡œ ê°ì‹¸ì§„ modelsë“¤ì„ ë§ˆì£¼ì³¤ì„ ë•Œ í˜¼ë€ìŠ¤ëŸ½ì§€ ì•Šê²Œ ë„ì™€ì¤€ë‹¤.

^^^^^^^^^^

### Refactoring #exhibit

ì–¼ë§ˆì „ì— ì•„ë˜ ì½”ë“œë¥¼ ì‘ì„±í–ˆì—ˆë‹¤.

```ruby
# app/helpers/exhibits_helper.rb
module ExhibitsHelper
    def exhibit(model, context)
        # Doing a string comparison because of Rails class-reloading weirdness
        case model.class.name
        when 'Post'
            if model.picture?
                PicturePostExhibit.new(model, context)
            else
                TextPostExhibit.new(model, context)
            end
        else
            model
        end
    end
end
```

í•œí¸ìœ¼ë¡ , ì´ exhibitì´ ì£¼ì–´ì§€ëŠ” ê°ì²´ì—ê²Œ ë¬´ì—‡ì„ ì ìš©í• ì§€ ë³´ê¸°ì‰½ë‹¤. ë‹¤ë¥¸ í•œí¸ìœ¼ë¡œëŠ” ì¡°ê±´ë¬¸ì˜ ì¤‘ì²©ìœ¼ë¡œ ë³´ì¸ë‹¤. ë¦¬íŒ©í† ë§ ì—†ì´ ë¬´ì–¸ê°€ë¥¼ ì¶”ê°€í•  ìˆ˜ ì—†ì–´ ë³´ì¸ë‹¤. 

í•œê°€ì§€ ë¦¬íŒ©í† ë§ ë°©ë²•ì„ ì‚´í´ë³´ì. ë¨¼ì €, ExhibitsHelper#exhibit method ë¥¼ í´ë˜ìŠ¤ ë©”ì„œë“œë¥¼ Exhibit í´ë˜ìŠ¤ì—ê²Œ ìœ„ì„í•˜ê¸° ìœ„í•´ ì½”ë“œë¥¼ ë‹¤ì‹œ ì‘ì„±í•œë‹¤. 

```ruby
# ...
def exhibit(model, context)
    Exhibit.exhibit(model, context)
end
# ...
```

Exhibit.exhibitì„ ì •ì˜í•˜ê³ , ì œê³µëœ ê°ì²´ë¥¼ ê°ì‹¸ì£¼ë©´ì„œ exhibitsì˜ listë¥¼ ìˆœíšŒí•œë‹¤.

```ruby
class Exhibit < SimpleDelegator
    # ...
    def self.exhibit(object, context)
        exhibits.inject(object) do |object, exhibit|
            exhibit.exhibit_if_applicable(object, context)
        end
    end
    # ...
end
```

Exhibit.exhibit_if_applicableë¥¼ ì •ì˜í•˜ì—¬ ì£¼ì–´ì§„ ëŒ€ìƒì— ëŒ€í•´ .applicable_to?ë¥¼ ë¬¼ì–´ë³´ê³ , ê²°ê³¼ê°€ trueì´ë©´ ì¸ìŠ¤í„´ìŠ¤í™” í•œë‹¤.

```ruby
class Exhibit < SimpleDelegator
    # ...
    def self.exhibit_if_applicable(object, context)
        if applicable_to?(object)
            new(object, context)
        else
            object
        end
    end
    # ...
end
```

Exhibitì—ì„œ .applicable_to?ëŠ” falseë¥¼ ë¦¬í„´í•˜ê³ , ìì‹ classeë“¤ì—ì„œëŠ” ê·¸ì— ë§ëŠ” ê°ì²´ë¥¼ ë¦¬í„´í•œë‹¤.

```ruby
def self.applicable_to?(object)
    false
end
```

applicable_to? ë©”ì„œë“œë¥¼ ê°ê°ì˜ ìì‹ í´ë˜ìŠ¤ì— ì¶”ê°€í–ˆë‹¤. PicturePostExhibit.applicable_to? methodëŠ” ì£¼ì–´ì§„ ê°ì²´ê°€ picture Postê°€ ë§ëŠ”ì¹˜ ì²´í¬í•œë‹¤.

```ruby
class PicturePostExhibit < Exhibit
    def self.applicable_to?(object)
        object.is_a?(Post) && object.picture?
    end
    # ...
end
```

Likewise for the other two exhibits:

```ruby
class TextPostExhibit < Exhibit
    def self.applicable_to?(object)
        object.is_a?(Post) && (!object.picture?)
    end
    # ...
end

class LinkExhibit < Exhibit
    # ...
    def self.applicable_to?(object)
        object.is_a?(Post)
    end
    # ...
end
```

ì œ, Exhibit.exhibitsë¥¼ ë¦¬í„´í•˜ê¸° ìœ„í•´ exhibitsë¦¬ìŠ¤íŠ¸ë¥¼ í•˜ë“œì½”ë”© í•œë‹¤.

```ruby
class Exhibit < SimpleDelegator
    def self.exhibits
        [
            TextPostExhibit,
            PicturePostExhibit,
            LinkExhibit
            ]
    end
    # ...
end

```

ëª©ë¡ì„ í•˜ë“œì½”ë”© í•˜ëŠ”ê²ƒì€ DRYì™€ëŠ” ê±°ë¦¬ê°€ ë©€ë‹¤. ëŒ€ì‹ ì—, Exhibitì— ìˆëŠ” inherited callbackë¥¼ ì •ì˜í•  ìˆ˜ ìˆëŠ”ë°, Exhibitì€ ìë™ì ìœ¼ë¡œ ë‚´ë¶€ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë  ê²ƒì´ë‹¤. ë¦¬ìŠ¤íŠ¸ë¥¼ í•˜ë“œì½”ë”©í•˜ëŠ” ì¥ì ì€ ì¼ê´€ë˜ê³  ë¶„ëª…í•œ exhibitsì˜ ìˆœì„œë¥¼ ë³´ì¥í•œë‹¤ëŠ” ê²ƒì´ê³ , ìš°ë¦¬ëŠ” ì–´ë–¤ exhibitsì´ ì ìš©ë  ìˆ˜ ìˆëŠ”ì§€ ì•Œê³  ìˆë‹¤. 

ë‘ê°€ì§€ ì ‘ê·¼ ë°©ë²• ëª¨ë‘ ì¥ì ì´ ìˆì§€ë§Œ, ê°œì¸ì ìœ¼ë¡œëŠ” ìë™ìƒì„±ëœ í´ë˜ìŠ¤ ëª©ë¡ì„ ë””ë²„ê¹…í•œ ê²½í—˜ì„ í†µí•´ ëª…ì‹œì ìœ¼ë¡œ ëª©ë¡ì„ í•˜ë“œì½”ë”© í•˜ëŠ” ìª½ì´ ë” ì¢‹ì•„ë³´ì¸ë‹¤.

### Do we need helpers?

ë ˆì¼ì¦ˆ helperëŠ” ì½”ë“œë¥¼ í¬ê³  ì •ëˆë˜ì§€ ì•Šê²Œ ë§Œë“œëŠ” ê²½í–¥ì´ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ì•„ë˜ì™€ ê°™ì€ ì½”ë“œë¥¼ ë³¸ì ì´ ìˆì„ ê²ƒì´ë‹¤.

```ruby
if current_user.logged_in?
    # ...
else
    # ...
end
```

helpersê°€ í•„ìš”ì—†ë‹¤ëŠ” ê²ƒì€ ì•„ë‹ˆë‹¤. ì¼ë°˜ì ì¸ ë Œë”ë§ ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•  ë•Œ ìœ ìš©í•˜ë‹¤.

```ruby
module FigureHelper
    def figure(image_path, caption)
        content_tag(:figure) do
            image_tag(image_path) +
                content_tag(:figcaption, caption)
        end
    end
end
```

This helper generates markup that looks like this:

```erb
<figure>
    <img alt="freshpaint.jpg" src="http://example.org/f.jpg" />
    <figcaption>Fresh paint</figcaption>
</figure>
```

## 10. Making the data stick around