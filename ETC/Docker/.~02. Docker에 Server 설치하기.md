# 02. Docker에 Server 설치하기

## 🔹컨테이너에서 직접 설치하는 방법

### 1. 도커에 Nginx 설치하기 

#### 1-1. OS image 다운로드

`sudo docekr pull os이름:버전`

#### 1-2. run 명령으로 컨테이너 생성하기

> docker run <옵션> <이미지 이름> <실행할 파일>

`sudo docker run -i -t --name ft_server -d -p 80:80 debian:buster`

#### 1-3. 실행중인 컨테이너에 접속하기

`sudo docker attach ft_server`

>cf) 컨테이너 종료 방법
>
>`exit`

>cf) 컨테이너 실행시킨 상태를 유지하고 빠져나오는 법
>
>`ctrl+P`를 누르고 `ctrl+Q`를 누른다.

> cf) 컨테이너에 접속하지 않고 컨테이너 내부의 명령어 실행하는 방법
>
> `sudo docker exec <컨테이너 이름> <명령어>`

#### 1-4. Nginx 설치 하기

`apt-get update`

`apt-get upgrade`

`apt-get install -y nginx`

#### 1-5. Nginx 서버 실행하기

`service nginx start`

### 2. Nginx + php 연동하기

#### 2-1. php 설치

`apt-get install -y php7.3-fpm`

#### 2-2. vim 설치

`apt-get install -y vim`

> cf) 설치 확인
>
> `cd /etc`
>
> `ls -l`
>
> 보통 설치된 패키지는 etc에 위치해 있음
>
> nginx, php, vim 3가지 확인

#### 2-3. php와 nginx 연동을 위한 환경설정

- 기본 index (main page)를 변경

  `vim /etc/nginx/sites-available/default` 로 실행

  - `root /var/www/html;`  를 `root /home;`으로 변경 (main page의 html 파일을 home에서 찾겠다는 의미 => 추후에 home에 page를 생성해야함)

  - `index index.html index.htm index.nginx-debian.html;`에 `index.php`추가

    => `index index.php index.html index.htm index.nginx-debian.html;`

  - 아래의 주석을 제거해 php CGI 서버를 활성화를 해준다.

    ![img](https://i.imgur.com/OsITEx3.png)

- php 환경설정 변경

  `vim /etc/php/7.3/fpm/php.ini` 로 실행

  - short_open_tag를 켜서 php 구문을 자동으로 인식하게 바꿔줌

    `/short` 를 치고 엔터를 치고, `n`을 눌러서 ` short_open_tag = Off`를 찾아 `short_open_tag = On`으로 변경해 준다.

  - `/cgi.fix`를 치고 엔터를 치고, `n`을 눌러서, `cgi.fix_pathinfo = 1`을 찾아 주석을 해제하고`cgi.fix_pathinfo = 0`으로 변경해 준다.

  `vim /etc/php/7.3/cli/php.ini` 로 실행

  - short_open_tag를 켜서 php 구문을 자동으로 인식하게 바꿔줌

    `/short` 를 치고 엔터를 치고, `n`을 눌러서 ` short_open_tag = Off`를 찾아 `short_open_tag = On`으로 변경해 준다.

  - `/cgi.fix`를 치고 엔터를 치고, `n`을 눌러서, `cgi.fix_pathinfo = 1`을 찾아 주석을 해제하고`cgi.fix_pathinfo = 0`으로 변경해 준다.

#### 2-4. php socket 생성

- nginx 재실행 및 php 실행

  `service nginx restart`

  `service php7.3-fpm start`

  `/var/run/php/php7.3-fpm.scok` 생성확인

#### 2-5. main page home 디렉토리로 이동하기

- 그냥 로컬 호스트에 접속해보면, 403 Frobidden 에러가 뜬다. 이는 main page가 위치한 디렉토리를 home으로 변경해 주었는데, home에는 아무것도 없기 때문이다.

- `cp /var/www/html/*.* /home` : 기존에 메인페이지를 home으로 복사

- 만약, 계속해서 403 Forbidden 에러가 뜬다면, 

  `service nginx restart`

  `service php7.3-fpm restart`

  를 해주고 재확인 해본다.

#### 2-6. php 연동 확인

- home directory에서 `vim info.php`을 치고 아래를 입력하여 파일을 저장

  ```php
  <?
  phpinfo();
  ?>
  ```

- http://localhost/info.php 를 실행시켜 php의 정보를 확인한다.

#### 2-7. php gd 라이브러리 설치 (php 이미지 처리 라이브러리)



## 🔹Dockerfile을 통해 한번에 설치하는 법

### 1. Dockerfile 작성

```dockerfile
FROM debian:buster
MAINTAINER	jjo	jjo@student.42seoul.kr

RUN apt-get update
RUN apt-get upgrade -y
RUN apt-get install -y nginx
RUN echo "\ndaemon off;" >> /etc/nginx/nginx.conf
RUN chown -R www-data:www-data /var/lib/nginx
RUN apt-get install -y php7.3-fpm

VOLUME [ "/data", "/etc/nginx/site-enabled", "var/log/nginx" ]

WORKDIR /etc/nginx

CMD [ "nginx" ]

EXPOSE 80
EXPOSE 443
```

>FROM
>
>- 기본이 되는 이미지 파일을 결정함. 
>- 기존에 만들어진 이미지를 기반으로 생성하고 로컬에 없으면 서버에서 자동으로 다운로드 함.  
>- `<이미지 이름>:<태그>` 형식으로 설정.
>
>MAINTAINER: 메인테이너 정보입니다.
>
>RUN: Shell 스크립트 혹은 명령을 실행합니다.
>
>- 이미지 생성 중에는 사용자 입력을 받을 수 없으므로 apt-get install 명령에서 `-y` 옵션을 사용합니다(yum install도 동일).
>- 나머지는 nginx 설정입니다.
>
>VOLUME: 호스트와 공유할 디렉터리 목록입니다. `docker run` 명령에서 `-v` 옵션으로 설정할 수 있습니다. 예) `-v /root/data:/data` 호스트의 **/root/data** 디렉터리를 Docker 컨테이너의 **/data** 디렉터리에 연결합니다.
>
>CMD: 컨테이너가 시작되었을 때 실행할 실행 파일 또는 스크립트입니다.
>
>WORKDIR: CMD에서 설정한 실행 파일이 실행될 디렉터리입니다.
>
>EXPOSE: 호스트와 연결할 포트 번호입니다.

### 1-3. build해서 이미지 파일 만들기

도커파일이 위치한 root dir로 이동 후 아래 명령어 실행

 ` docker build --tag ft_server:1.0 .` 

### 1-4. 이미지 파일 run 해서 컨테이너 실행

`docker run --name ft_server-nginx -d -p 80:80 -v /root/data:/data ft_server:1.0`

### 1-5. localhost 실행해서 Nginx 서버 작동 확인

http://localhost/