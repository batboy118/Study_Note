# 05. íŒ¨ìŠ¤í¬íŠ¸ê¸°ë°˜ ì¸ì¦ ë¡œì§ êµ¬í˜„

> íŒ¨ìŠ¤í¬íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œí•œ íšŒì›ê°€ì…, ë¡œê·¸ì¸, ë¡œê·¸ì•„ì›ƒì˜ ë¡œì§ êµ¬í˜„ê³¼ ì¸ì¦ì²˜ë¦¬ í•™ìŠµ

[ğŸ Home](https://github.com/batboy118/Study_Note)

[â—€Previous page ](./README.md)

---

<!-- TOC -->

- 

<!-- /TOC -->

## 1.  passport í™˜ê²½êµ¬ì¶•

ì„¸ì…˜ì´ë€, í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë¡œê·¸ì¸ì„ í–ˆì„ ê²½ìš° ì„œë²„ì˜ ë©”ëª¨ë¦¬ë‚˜ DBì—ì„œ í´ë¼ì´ì–¸íŠ¸ì˜ IDê°’ì„ ë§Œë“¤ì–´ ë¡œê·¸ì¸í–ˆì„ ë•Œ ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ê²ƒì´ë‹¤.

ë¡œê·¸ì¸ í–ˆì„ ë•Œì˜ í˜ì´ì§€ì™€ ì•„ë‹ë•Œì˜ í˜ì´ì§€ë¥¼ êµ¬ë¶„í•  í•„ìš”ê°€ ìˆìœ¼ë©°, ì„œë²„ì—ì„œëŠ” ë¡œê·¸ì¸ ìƒíƒœì— ëŒ€í•œ ìƒíƒœë¥¼ ìœ ì§€í•´ì•¼ í•œë‹¤.

ë¨¼ì €, join.html  íŒŒì¼ì„ ì‚­ì œí•˜ê³ , join.ejs íŒŒì¼ì„ views ë””ë ‰í† ë¦¬ ì•„ë˜ì— ë§Œë“¤ì–´ ì•„ë˜ ë‚´ìš©ìœ¼ë¡œ ë³€ê²½í•˜ë„ë¡ í•˜ì.

```javascript
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=<device-width>, initial-scale=1.0">
	<title>Join !</title>
	<style>
		.message{
			color : #963b3b;
			margin-bottom : 16px;
		}
	</style>
</head>
<body>
	<h1>join my website!</h1>
	<section class="message"><=% message %></section>
	<form action="/join" method="post">
		email : <input type="text" name="email"><br>
		name : <input type="text" name="name"><br>
		password : <input type="text" name="password"><br>
		<input type="submit">
	</form>
</body>
</html>
```

join/index.js íŒŒì¼ë„ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •í•œë‹¤.

```javascript
//join/index.js
const express = require('express');
const app = express();
const router = express.Router();
const path = require('path');

const mysql = require('mysql');
const connection = mysql.createConnection({
	host : 'localhost',
	port : 3306 , //default í¬íŠ¸
	user : 'root',
	pasword : "",
	database : 'jsman'
})
connection.connect(); // ì»¤ë„¥ì…˜ ê°ì²´ì—ì„œ connectë¼ëŠ” ë©”ì†Œë“œë¥¼ ì‹¤í–‰í•œë‹¤.

//ë¼ìš°í„°ë¥¼ ëª¨ë“ˆë¡œ exportí•œë‹¤. ë‹¤ë¥¸ íŒŒì¼ì—ì„œ ì´ ëª¨ë“ˆì„ ì½ì–´ì™€ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

//get
router.get("/", function(req,res){
	console.log("get join url")
	res.render('join.ejs',{message:''})
})

//post
router.post("/", function(req,res){
	let body = req.body;
	let userInfo = {
		email : body.email,
		name : body.name,
		pw : body.password
	}
	console.log(userInfo)
	let query = connection.query(`insert into user set ?`, userInfo, function(err,rows){
		if(err) throw err;
		else res.render('welcome.ejs', {'name' : userInfo.name, 'id' : rows.insertId});
		console.log("OK : " , rows, rows.insertId, userInfo);
	})
})

module.exports = router;
```

ì´ì œ passportë¥¼ ì„¤ì¹˜í•´ë³´ì.

`npm install passport passport-local express-session connect-flash --save-dev`

-  passport : ì¸ì¦ ê´€ë ¨ ëª¨ë“ˆ
- passport-local : ì¼ë°˜ì ì¸ ë¡œê·¸ì¸ ì²˜ë¦¬ë¥¼ ìœ„í•œ ëª¨ë“ˆ (ë¡œê·¸ì¸ ì •ë³´ë¥¼ ë¡œì»¬ DBì— ì €ì¥í•˜ëŠ” ë¡œê·¸ì¸ ì²˜ë¦¬)
- express-session : ì„¸ì…˜ ê´€ë¦¬ ì²˜ë¦¬
- connect-flash : ì—ëŸ¬ë©”ì‹œì§€ ë“±ì„ ë¦¬ë‹¤ì´ë ‰íŠ¸ í•´ì£¼ëŠ” ê²ƒì„ ë„ì™€ì£¼ëŠ” ëª¨ë“ˆ

 ì„¤ì¹˜ê°€ ëë‚¬ë‹¤ë©´, app.jsì—ì„œ ëª¨ë“ˆì„ ì¶”ê°€í•´ì¤€ë‹¤.

```javascript
//app.js
const express = require('express');
const app = express()
const port = 3000
const bodyParser = require('body-parser');
const router = require('./router/index');
const passport = require('passport');
const LocalStrategy = require('passport-local').Strategy;
const session = require('express-session');
const flash = require('connect-flash');

app.listen(port, function() {
	console.log("start express server on port 3000");
})

app.use(bodyParser.json())
app.use(bodyParser.urlencoded({extended:true}))
app.use(express.static("public"))
app.set('view engine', 'ejs')

//ì„¸ì…˜ ì„¤ì •
app.use(session({
	secret: 'keyboard cat',
	resave : false,
	saveUninitialized : true
}))
//passport ì´ˆê¸°í™”
app.use(passport.initialize());
app.use(passport.session());
app.use(flas());

//ë¼ìš°íŒ… ëª¨ë“ˆ
app.use(router);  //pathê°€ ì—†ì„ ë•ŒëŠ” path ìƒëµê°€ëŠ¥
```

- const passport = require('passport');
- const LocalStrategy = require('passport-local').Strategy;
- const session = require('express-session');
- const flash = require('connect-flash');
- ì„¸ì…˜ ì„¤ì •
  - secret: 'keyboard cat'
    - secret : ì„¸ì…˜ì„ ì•”í˜¸í™” í•˜ê¸° ìœ„í•œ ë¬¸ìì—´ë¡œëœ í‚¤ê°’('keyboard cat'ë§ê³  ë‹¤ë¥¸ ë¬¸ìì—´ì„ ë„£ì–´ë„ ë¨). ì¿ í‚¤ë¥¼ ì„ì˜ë¡œ ë³€ì¡°í•˜ëŠ”ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•œ ê°’ìœ¼ë¡œ ì´ ê°’ì„ í†µí•˜ì—¬ ì„¸ì…˜ì„ ì•”í˜¸í™” í•˜ì—¬ ì €ì¥
  - resave : false
    - ì„¸ì…˜ì„ ì–¸ì œë‚˜ ì €ì¥í•  ì§€ (ë³€ê²½ë˜ì§€ ì•Šì•„ë„) ì •í•˜ëŠ” ê°’. express-session documentationì—ì„œëŠ” ì´ ê°’ì„ false ë¡œ í•˜ëŠ”ê²ƒì„ ê¶Œì¥í•˜ê³  í•„ìš”ì— ë”°ë¼ trueë¡œ ì„¤ì •
  - saveUninitialized : true
    - ì„¸ì…˜ì´ ì €ì¥ë˜ê¸° ì „ì— uninitialized ìƒíƒœë¡œ ë¯¸ë¦¬ ë§Œë“¤ì–´ì„œ ì €ì¥

`join/index.js`ë„ ì•„ë˜ì™€ ê°™ì´ ë°”ê¾¸ì–´ì¤€ë‹¤.

```javascript
//join/index.js
const express = require('express');
const app = express();
const router = express.Router();
const path = require('path');
const passport = require('passport');
const LocalStrategy = require('passport-local').Strategy;

const mysql = require('mysql');
const connection = mysql.createConnection({
	host : 'localhost',
	port : 3306 , //default í¬íŠ¸
	user : 'root',
	pasword : "",
	database : 'jsman'
})
connection.connect(); // ì»¤ë„¥ì…˜ ê°ì²´ì—ì„œ connectë¼ëŠ” ë©”ì†Œë“œë¥¼ ì‹¤í–‰í•œë‹¤.

//ë¼ìš°í„°ë¥¼ ëª¨ë“ˆë¡œ exportí•œë‹¤. ë‹¤ë¥¸ íŒŒì¼ì—ì„œ ì´ ëª¨ë“ˆì„ ì½ì–´ì™€ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

//get
router.get("/", function(req,res){
	console.log("get join url")
	res.render('join.ejs',{message:''})
})

//ejsíŒŒì¼ì˜ inputì—ì„œ emailê³¼ passwordë¥¼ ì‚¬ìš©
passport.use('local-join', new LocalStrategy({
		usernameField: 'email',
		passwordField: 'password',
		passReqToCallback : true
	}, function(req, email, password, done){
		console.log('local-join callback called')
}));

module.exports = router;
```

- middleware,strategy ì„¤ì •ì„ ëë§ˆì³¤ë‹¤. ì´ì œ passport ê¸°ë°˜ì˜ ë¼ìš°í„° ì„¤ì •ì„ ì¶”ê°€í•´ì•¼ í•œë‹¤.

## 2. passport ê¸°ë°˜ router ì„¤ì •

ì•„ë˜ì™€ ê°™ì´ `join/index.js` ì„¤ì •

```javascript
//join/index.js
const express = require('express');
const app = express();
const router = express.Router();
const path = require('path');
const passport = require('passport');
const LocalStrategy = require('passport-local').Strategy;

const mysql = require('mysql');
const connection = mysql.createConnection({
	host : 'localhost',
	port : 3306 , //default í¬íŠ¸
	user : 'root',
	pasword : "",
	database : 'jsman'
})
connection.connect(); // ì»¤ë„¥ì…˜ ê°ì²´ì—ì„œ connectë¼ëŠ” ë©”ì†Œë“œë¥¼ ì‹¤í–‰í•œë‹¤.

//ë¼ìš°í„°ë¥¼ ëª¨ë“ˆë¡œ exportí•œë‹¤. ë‹¤ë¥¸ íŒŒì¼ì—ì„œ ì´ ëª¨ë“ˆì„ ì½ì–´ì™€ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

//get
router.get("/", function(req,res){
	console.log("get join url")
	res.render('join.ejs',{message:''})
})

//ejsíŒŒì¼ì˜ inputì—ì„œ emailê³¼ passwordë¥¼ ì‚¬ìš©
passport.use('local-join', new LocalStrategy({
		usernameField: 'email',
		passwordField: 'password',
		passReqToCallback : true
	}, function(req, email, password, done){
		console.log('local-join callback called')
}));


router.post('/', passport.authenticate('local-join', {
	successRediret : '/main',    // íšŒì›ê°€ì…ì´ ì˜ ë˜ì—ˆìœ¼ë©´ /mainìœ¼ë¡œ ì´ë™
	failureRedirect : '/join',   // ì‚¬ìš©ìê°€ ìˆì„ ê²½ìš° ë‹¤ì‹œ íšŒì›ê°€ì… ì°½ìœ¼ë¡œ
	failureFlash: true
	})
);

module.exports = router;
```

- postìš”ì²­ì´ ì˜¤ë©´ `passport.authenticate('local-join', {} )` ì½œë°±í•¨ìˆ˜ë¥¼ ì‹¤í–‰ ì‹œí‚¨ë‹¤. ì´ë•Œ ë¯¸ë¦¬ ë§Œë“¤ì–´ ë‘”`local-join` LocalStrayegyë¥¼ ì¸ìë¡œ ì£¼ë©´ í•´ë‹¹ LocalStrayegyì— ë§ì¶”ì–´ ë™ì‘í•˜ê²Œ ëœë‹¤.
- `successRediret` : ì„±ê³µì‹œ ë³´ì—¬ì¤„ í˜ì´ì§€ë¥¼ ë¦¬ë‹¤ì´ë ‰íŠ¸
- `failureRedirect` : ì‹¤íŒ¨ì‹œ ë³´ì—¬ì¤„ í˜ì´ì§€ë¥¼ ë¦¬ë‹¤ì´ë ‰íŠ¸

`local-join` LocalStrayegyì— DB ì¿¼ë¦¬ë¬¸ì„ ì‘ì„±í•´ ë³´ì.

```javascript
//join/index.js
const express = require('express');
const app = express();
const router = express.Router();
const path = require('path');
const passport = require('passport');
const LocalStrategy = require('passport-local').Strategy;

const mysql = require('mysql');
const connection = mysql.createConnection({
	host : 'localhost',
	port : 3306 , //default í¬íŠ¸
	user : 'root',
	pasword : "",
	database : 'jsman'
})
connection.connect(); // ì»¤ë„¥ì…˜ ê°ì²´ì—ì„œ connectë¼ëŠ” ë©”ì†Œë“œë¥¼ ì‹¤í–‰í•œë‹¤.

//ë¼ìš°í„°ë¥¼ ëª¨ë“ˆë¡œ exportí•œë‹¤. ë‹¤ë¥¸ íŒŒì¼ì—ì„œ ì´ ëª¨ë“ˆì„ ì½ì–´ì™€ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

//get
router.get("/", function(req,res){
	console.log("get join url")
	let msg;
	const errMsg = req.flash('error');
	if(errMsg) msg = errMsg;
	res.render('join.ejs',{message:msg})
})

//ejsíŒŒì¼ì˜ inputì—ì„œ emailê³¼ passwordë¥¼ ì‚¬ìš©
passport.use('local-join', new LocalStrategy({
		usernameField: 'email',
		passwordField: 'password',
		passReqToCallback : true
	}, function(req, email, password, done){
		const query = connection.query('select * from user where email=?', [email], function(err, rows){
			const body = req.body;
			if(err){ return done(err); }
			//console.log(rows);
			if(rows.length){
				console.log('alraedy taken');
				return done(null, false, {message : `your email is already used`});  //falseë¥¼ ì£¼ë©´ failureRedirectë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ëœë‹¤. (ë©”ì„¸ì§€ë„ í•¨ê¼ ì „ë‹¬í•  ìˆ˜ ìˆë‹¤.)
			} else {
				const sql = {'email': body.email, 'pw': body.password, 'name':body.name};
				const query = connection.query('insert into user set ?', sql, function(err, rows){
					if(err) throw err;
					console.log('well created');
					return done(null, {'email' : email, 'id' : rows.insertId});  //true ì£¼ë©´ successRediretë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ëœë‹¤. (ë©”ì„¸ì§€ë„ í•¨ê¼ ì „ë‹¬í•  ìˆ˜ ìˆë‹¤.)
				})
			}
		})
}));


router.post('/', passport.authenticate('local-join', {
	successRediret : '/main',    // íšŒì›ê°€ì…ì´ ì˜ ë˜ì—ˆìœ¼ë©´ /mainìœ¼ë¡œ ì´ë™
	failureRedirect : '/join',   // ì‚¬ìš©ìê°€ ìˆì„ ê²½ìš° ë‹¤ì‹œ íšŒì›ê°€ì… ì°½ìœ¼ë¡œ
	failureFlash: true
	})
);

module.exports = router;
```

