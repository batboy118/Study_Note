# 05. Rails Authorization

>íšŒì›ê°€ì…, ë¡œê·¸ì¸, ë¡œê·¸ì•„ì›ƒë“¤ì˜ authenticationì„ ë°°ì› ë‹¤. ì´ì œëŠ” ê±°ê¸°ì— ì¶”ê°€ì ìœ¼ë¡œ ìœ ì €ë§ˆë‹¤ ë‹¤ë¥¸ ê¶Œí•œì„ ì¤„ ìˆ˜ ìˆëŠ” ë°©ë²•ì— ëŒ€í•´ì„œ í•™ìŠµí•´ ë³´ì. ì˜ˆë¥¼ ë“¤ë©´, ë¸”ë¡œê·¸ì—ì„œëŠ” ë¸”ë¡œê·¸ì˜ ì£¼ì¸ë§Œ ê¸€ì„ ì“°ê³  ìˆ˜ì •í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ê°€ì§€ê³  ìˆë‹¤.

[ğŸ Home](https://github.com/batboy118/Study_Note)

[â—€Previous page ](./README.md)

---

<!-- TOC -->

- [1. Roles](#1-roles)
- [2. Admin Role](#2-admin-role)

<!-- /TOC -->

## 1. Roles

1. ë¸Œë¼ìš°ì €ê°€ URLì— ëŒ€í•œ ìš”ì²­ì„ í•œë‹¤.
2. ìš”ì²­ì´ ë¼ìš°í„°ë¡œ ë„ë‹¬í•œë‹¤.
3. ë¼ìš°í„°ì—ì„œ ì»¨íŠ¸ë¡¤ëŸ¬ë¡œ ìš”ì²­ì„ ë³´ë‚´ê¸°ì „ì—, ì–´í”Œë¦¬ì¼€ì´ì…˜ì€ ìœ ì €ì˜ roleì„ ë³´ê³  ìœ ì €ê°€ ê¶Œí•œì„ ê°€ì§€ê³  ìˆëŠ”ì§€ ì—†ëŠ”ì§€ ì²´í¬í•œë‹¤.

roleì´ë€ ìœ ì €ê°€ ì‚¬ì´íŠ¸ì˜ ì–´ë–¤ ë¶€ë¶„ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ”ì§€ ê´€ë¦¬í•˜ëŠ” ë°©ë²•ì´ë‹¤. roleì€ ë°ì´í„°ë² ì´ìŠ¤ì— ëª…ì‹œë˜ì–´ ìˆë‹¤.

`db/migrate`ì— ìˆëŠ” user í…Œì´ë¸”ì— stringìë£Œí˜•ì€ role ì»¬ëŸ¼ì„ ì¶”ê°€í•˜ê³ , ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì§„í–‰í•œë‹¤.

```ruby
class CreateUsers < ActiveRecord::Migration
  def change
    create_table :users do |t|
      t.string :first_name
      t.string :last_name
      t.string :email
      t.string :password_digest
      t.string :role
      t.timestamps null: false
    end
  end
end
```

ê·¸ í›„ `app/models/user.rb`íŒŒì¼ì— `editor?`ë©”ì„œë“œë¥¼ ì¶”ê°€í•œë‹¤. ì´ëŠ” userí…Œì´ë¸”ì˜ role ì»¬ëŸ¼ì—ì„œ ìœ ì €ê°€ ì—ë””í„°ì¸ì§€ í™•ì¸í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤.

```ruby
class User < ActiveRecord::Base

  has_secure_password

  def editor?
    self.role == 'editor'
  end

end
```

ë§Œì•½ `mateo`ë¼ëŠ” ìœ ì €ì˜ roleì´ editorë¼ë©´ rails consoleì—ì„œ ì•„ë˜ì˜ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤.

```ruby
> mateo = User.find_by(email: 'mateo@email.com')
> mateo.editor?
#true
```

ì´ì œ ì„¸ì…˜ì„ í™œìš©í•´ í˜„ì¬ ìœ ì €ê°€ ì—ë””í„°ì¸ì§€ í™•ì¸ì„ í•˜ëŠ” ê³¼ì •ì„ ì¶”ê¸°í•´ì•¼í•œë‹¤.

**app/controllers/application_controller.rb** ì— `require_editor`ë©”ì„œë“œë¥¼ ì¶”ê°€í•œë‹¤.

```ruby
class ApplicationController < ActionController::Base
  # Prevent CSRF attacks by raising an exception.
  # For APIs, you may want to use :null_session instead.
  protect_from_forgery with: :exception

   helper_method :current_user

   def current_user
     @current_user ||= User.find(session[:user_id]) if session[:user_id]
   end

   def require_user
     redirect_to '/login' unless current_user
   end

  def require_editor
    redirect_to '/' unless current_user.editor?
  end

end
```

ê·¸ í›„  `before_action`ë©”ì„œë“œë¥¼ ì´ìš©í•˜ì—¬ `show` and `edit` actionsì— ì ‘ê·¼í•˜ê¸° ì „ì—  `require_editor`ë¥¼ ì²´í¬ë¥¼ í•œë‹¤.

```ruby
before_action :require_editor, only: [:show, :edit]
```

ê·¸ë¦¬ê³  ë·°ì—ì„œë„, ìˆ˜ì •í•  ìˆ˜ ìˆëŠ” ë§í¬ëŠ” ì—ë””í„°ì—ê²Œë§Œ ë³´ì´ë„ë¡ ë§Œë“¤ì–´ ì¤€ë‹¤.

```erb
<% if current_user && current_user.editor? %>
  <p class="recipe-edit">
    <%= link_to "Edit Recipe", edit_recipe_path(@recipe.id) %>
  </p>
<% end %>
```

## 2. Admin Role

ìœ ì € ëª¨ë¸ì— `admin?` ë©”ì„œë“œë¥¼ ì¶”ê°€í•˜ì—¬ admin roleì„ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸í•˜ê²Œ í•œë‹¤.

```ruby
def admin?
    self.role == 'admin'
end
```

application_controllerì— require_admin ë©”ì„œë“œ ì¶”ê°€

```ruby
def require_admin
  redirect_to '/' unless current_user.admin?
end
```

ê·¸ë¦¬ê³ , destroyì— ëŒ€í•œ ê¶Œí•œì„ ì„¤ì •í•´ ì¤€ë‹¤.

```ruby
before_action :require_admin, only: [:destroy]
```

ê·¸ë¦¬ê³ , ë·°ì—ì„œë„ ê¶Œí•œì„ í™•ì¸í•˜ì—¬ ì‚­ì œ ë²„íŠ¼ì„ ë§Œë“¤ì–´ì¤€ë‹¤.

```erb
<% if current_user && current_user.admin? %>
  <p class="recipe-delete"><%= link_to "Delete", recipe_path(@recipe), method: "delete" %><p>
<% end %>
```

