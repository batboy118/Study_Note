# 04. Rails Authentication

>ì‚¬ìš©ì ì¸ì¦ì— ëŒ€í•œ ë‚´ìš©ì„ í•™ìŠµí•œë‹¤.

[ğŸ Home](https://github.com/batboy118/Study_Note)

[â—€Previous page ](./README.md)

---

<!-- TOC -->

- [1. Signup - User model](#1-signup---user-model)
- [2. Signup - Users Controller & Signup View](#2-signup---users-controller--signup-view)
- [3. Login - Sessions Controller](#3-login---sessions-controller)
- [4. Currentuser](#4-currentuser)

<!-- /TOC -->

## 1. Signup - User model

[request/response cycle](https://www.codecademy.com/articles/request-response-cycle-forms) ì— singupì„ ì‚¬ìš©í•˜ëŠ” ë²•

**Turn one:** (signup í™”ë©´ ë„ìš°ê¸°)

1. signup pageë¥¼ ë°©ë¬¸í•˜ë©´ ë¸Œë¼ìš°ì €ê°€ `/signup` URLì— ëŒ€í•œ HTTP GET request ìƒì„±
2. ë¼ìš°í„°ëŠ” `/signup` ì„ ë³´ê³  Users controllerì˜ `new` actionìœ¼ë¡œ ë§µí•‘í•´ì¤€ë‹¤. `new` actionì€ ìš”ì²­ì„ ì²˜ë¦¬í•˜ê³  ë·°ì—ê²Œ ì „ë‹¬í•œë‹¤.
3. ë·°ëŠ” signupí™”ë©´ì„ ë³´ì—¬ì¤€ë‹¤.

**Turn two:** (íšŒì› ì •ë³´ dbì— ì €ì¥í•˜ê¸°)

1. ìœ ì €ê°€ ì–‘ì‹ì„ ì‘ì„±í•˜ê³  ì œì¶œì„ í•˜ë©´, ë¸Œë¼ìš°ì €ê°€ HTTP POST requestì™€ í•¨ê»˜ ë°ì´í„°ë¥¼ ë³´ë‚¸ë‹¤.
2. ë¼ìš°í„°ëŠ” ìš”ì²­ì„  `create` actionìœ¼ë¡œ ë§µí•‘ì‹œí‚¨ë‹¤.
3. `create` actionì€ ë°ì´í„°ë¥¼ ë°ì´í„° ë² ì´ìŠ¤ì— ì €ì¥í•˜ê³  í˜ì´ì§€ë¥¼ ë¦¬ë‹¤ì´ë ‰íŠ¸ í•œë‹¤. ê·¸ë¦¬ê³  ìƒˆë¡œìš´ ì„¸ì…˜ì„ ë§Œë“¤ì–´ë‚¸ë‹¤.

> What is a session?
>
> A session is a connection between the **userâ€™s computer** and **the server** running the Rails app. A session starts when a user logs in, and ends when the user logs out.



ì´ì œ ë³¸ê²©ì ìœ¼ë¡œ `User` ëª¨ë¸ì„ ë‹¤ë£¨ì–´ë³´ì.

ë¨¼ì € `User` ëª¨ë¸ì„ ìƒì„±í•˜ê³ , `has_secure_password` ë©”ì„œë“œë¥¼ User ëª¨ë¸ í´ë˜ìŠ¤ì— ì…ë ¥í•œë‹¤.

**app/models/user.rb**,

```ruby
class User < ActiveRecord::Base

  has_secure_password

end
```

`has_secure_password` ë©”ì„œë“œëŠ” íŒ¨ìŠ¤ì›Œë“œë¥¼ ì•ˆì „í•˜ê²Œ ë³´ê´€í•  ìˆ˜ ìˆê²Œí•´ì¤€ë‹¤. íŒ¨ìŠ¤ì›Œë“œë¥¼ ì•ˆì „í•˜ê²Œ ì €ì¥í•˜ê¸° ìœ„í•´ì„œ `has_secure_password`ë©”ì„œë“œëŠ” `bcrypt`ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•œë‹¤. `bcrypt`ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ bcrypt gemì„ ì„¤ì¹˜í•´ì•¼í•œë‹¤.

Gemfileì—ì„œ bcryptì˜ ì£¼ì„ì²˜ë¦¬ë¥¼ ì‚­ì œí•œ ë’¤, gemë“¤ì„ installí•´ì¤€ë‹¤. (`bundle install`)



**db/migrate/**ì— ìˆëŠ” User í…Œì´ë¸”ì— ì•„ë˜ ì»´ëŸ¼ë“¤ì„ ì¶”ê°€í•œë‹¤.

- a string column called `first_name`
- a string column called `last_name`
- a string column called `email`
- a string column called `password_digest`

```ruby
class CreateUsers < ActiveRecord::Migration
  def change
    create_table :users do |t|
      t.string :first_name
      t.string :last_name
      t.string :email
      t.string :password_digest
      t.timestamps
    end
  end
end
```

`password_digest` columnì´ë€?

>  ì‚¬ìš©ìê°€ íŒ¨ìŠ¤ì›Œë“œë¥¼ submití•  ë•Œ íŒ¨ìŠ¤ì›Œë“œë¥¼ ê·¸ëŒ€ë¡œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ëŠ” ê²ƒì€ ë³´ì•ˆìƒ ì¢‹ì§€ ì•Šë‹¤. ë§Œì•½ í•´ì»¤ì— ì˜í•´ ê³µê²©ì„ ë°›ì•„ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ëœ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³´ê²Œ ë ìˆ˜ ìˆê¸°ë•Œë¬¸ì´ë‹¤.
>
> ì´ëŸ¬í•œ ë¬¸ì œë¥¼ ë§‰ê¸° ìœ„í•´, íŒ¨ìŠ¤ì›Œë“œë¥¼ ì•”í˜¸í™”ëœ string ë°ì´í„°ë¡œ ì €ì¥í•œë‹¤. ì´ ì‘ì—…ì€ `has_secure_password` methodì— ì˜í•´ ìˆ˜í–‰ë˜ë©°, ì‚¬ìš©ìì˜ ì•”í˜¸ë¥¼ í•´ì‹œí™” í•˜ì—¬ `password_digest` columnì— ì €ì¥í•œë‹¤.
>
> ìœ ì €ê°€ ë‹¤ì‹œ ë¡œê·¸ì¸ì„ í•  ë•Œ, `has_secure_password` methodëŠ” ì œì¶œëœ íŒ¨ìŠ¤ì›Œë“œë¥¼ í•´ì‹œí™” í•˜ì—¬ ë°ì´í„° ë² ì´ìŠ¤ì— ì €ì¥ëœ í•´ì‹œì™€ ë¹„êµí•œë‹¤.

## 2. Signup - Users Controller & Signup View

Users ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ìƒì„±í•˜ê³ , ì•„ë˜ì™€ ê°™ì´ ë¼ìš°íŒ… í•´ì¤€ë‹¤.

```ruby
get 'signup'  => 'users#new'
resources :users
```

Users controllerì— `new` actionì„ ì¶”ê°€í•œë‹¤.

```ruby
def new
  @user = User.new
end
```

**app/views/users/new.html.erb**ë¥¼ ì•„ë˜ì™€ ê°™ì´ ì‘ì„±í•œë‹¤.

```erb
<div class="login">
  <div class="container">
    <div class="form">

    <h1>Sign up</h1>

    <%=form_for(@user) do |f| %>
      <div class="form">
       FIRST NAME <%= f.text_field :first_name %><br>
       LAST NAME <%= f.text_field :last_name %><br>
       E-MAIL <%= f.text_field :email %><br>
       PASSWORD <%= f.password_field :password %>
      </div>
      <div class="btn-submit">
        <%= f.submit "Create" %>
      </div>
    <% end %>

    </div>
  </div>
</div>
```

ì´ë²ˆì—ëŠ” ì œì¶œëœ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ê³¼ì •ì„ êµ¬í˜„í•´ ë³´ì.

ë¨¼ì € Users controllerì— `create` actionê³¼ private method ì¸ `user_params`ì„ ì¶”ê°€í•œë‹¤.

```ruby
def create
	@user = User.new(user_params)
    if @user.save
        session[:user_id] = @user.id
        redirect_to '/'
    else
        redirect_to '/signup'
    end
end

private

def user_params
    params.require(:user).permit(:first_name, :last_name, :email, :password)
end
```

ì–‘ì‹ì„ ì±„ìš°ê³  ì œì¶œí•˜ë©´ Rails appì€ POST requestë¥¼ ë°›ëŠ”ë‹¤. User controllerì˜ `create` actionì„ í†µí•´ dataê°€ ì €ì¥ë˜ê³  ìƒˆë¡œìš´ sessionì„ ë§Œë“¤ê³  redirect ëœë‹¤.

ì„¸ì…˜ì€ í‚¤-ë°¸ë¥˜ ì§ìœ¼ë¡œ ì €ì¥ëœë‹¤. ì•„ë˜ ì½”ë“œë¥¼ ë³´ë©´, session í•´ì‹œë§µì— `:user_id`ë¥¼ í‚¤ë¡œ ê°€ì§€ëŠ” `@user.id`ê°€ ì €ì¥ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```ruby
session[:user_id] = @user.id
```

## 3. Login - Sessions Controller

ë¡œê·¸ì¸ í•˜ëŠ” ë°©ë²•

**Turn one:**

1. ìœ ì €ê°€ ë¡œê·¸ì¸ í˜ì´ì§€ë¥¼ ë°©ë¬¸í•˜ë©´ ë¸Œë¼ìš°ì €ê°€ GET requestë¥¼ ë³´ë‚¸ë‹¤. (URL `/login`).
2. ë ˆì¼ì¦ˆ ë¼ìš°í„°ê°€ URL `/login`ì„ Sessions controllerì˜ `new` actionìœ¼ë¡œ ë§µí•‘í•˜ê³ ,  `new` actionì€ ìš”ì²­ì„ ë‹¤ë£¨ê³  ë·°ë¡œ ë³´ë‚¸ë‹¤.
3. ë·°ì—ì„œ ë¡œê·¸ì¸ í¼ì„ ë³´ì—¬ì¤€ë‹¤.

**Turn two:**

1. ìœ ì €ê°€ í¼ì„ ì‘ì„±í•˜ê³  ì œì¶œí•˜ë©´, ë¸Œë¼ìš°ì €ê°€ POST requestë¥¼ appìœ¼ë¡œ ë³´ë‚¸ë‹¤.
2. ë¼ìš°í„°ê°€ ìš”ì²­ì„ Sessions controllerì˜ `create` actionìœ¼ë¡œ ë§µí•‘ì‹œí‚¨ë‹¤.
3. `create` actionì€ ìœ ì €ê°€ ë°ì´í„° ë² ì´ìŠ¤ì— ì¡´ì¬í•˜ëŠ”ì§€ ê²€ì¦í•˜ê³ , ë§Œì•½ ìœ ì €ê°€ ì¡´ì¬í•œë‹¤ë©´ `create` ì•¡ì…˜ì—ì„œ ìƒˆë¡œìš´ ì„¸ì…˜ì„ ë§Œë“¤ì–´ ìœ ì €ë¥¼ ë¡œê·¸ì¸ ì‹œí‚¨ë‹¤. ë§Œì•½ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¥¼ ë¦¬ë¡œë“œ ì‹œí‚¨ë‹¤.

ë¨¼ì € Sessions ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ìƒì„±í•œë‹¤. ê·¸ë¦¬ê³  `/login` ì„ Sessions controllerì˜ `new` actionìœ¼ë¡œ ë§µí•‘ ì‹œí‚¨ë‹¤.

Sessionsì»¨íŠ¸ë¡¤ëŸ¬ì— new ì•¡ì…˜ì„ ì¶”ê°€í•œë‹¤.

```ruby
def new
end
```

ê·¸ë¦¬ê³  **app/views/sessions/new.html.erb**ì— ì–‘ì‹ì„ ë§Œë“¤ì–´ ì¤€ë‹¤.

```erb
<div class="login">
	<div class="container">
		<div class="form">

      <h1>Log in</h1>

      <%= form_for(:session, url: login_path) do |f| %>
          <%= f.email_field :email, :placeholder => "Email" %>
          <%= f.password_field :password, :placeholder => "Password" %>
          <%= f.submit "Log in", class: "btn-submit" %>
      <% end %>

    </div>
  </div>
</div>
```

ì´ì œëŠ” ì œì¶œëœ ì–‘ì‹ì„ ì´ìš©í•˜ì—¬ ì„¸ì…˜ì„ ìƒì„±í•˜ëŠ” ê²ƒì„ êµ¬í˜„í•˜ì.

ìš°ì„  loginì„ ì•„ë˜ì™€ ê°™ì´ ë§µí•‘ì‹œí‚¨ë‹¤.

```ruby
post 'login' => 'sessions#create'
```

ê·¸ í›„ create ì•¡ì…˜ì„ ì„¸ì…˜ ì»¨íŠ¸ë¡¤ëŸ¬ì— ì¶”ê°€í•œë‹¤.

```ruby
def create
  @user = User.find_by_email(params[:session][:email])
  if @user && @user.authenticate(params[:session][:password])
    session[:user_id] = @user.id
    redirect_to '/'
  else
    redirect_to 'login'
  end
end
```

ë¨¼ì € ì œì¶œëœ ì„¸ì…˜ ì •ë³´ì—ì„œ ì´ë©”ì¼ì„ ì´ìš©í•˜ì—¬ í•´ë‹¹ ìœ ì €ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì—¬ @userë³€ìˆ˜ì— ë„£ëŠ”ë‹¤. ê·¸ í›„ @userê°€ ì¡´ì¬í•˜ê³  @userì˜ íŒ¨ìŠ¤ì›Œë“œê°€ ì¼ì¹˜(`authenticate ë©”ì„œë“œ ì‚¬ìš©`)í•˜ë©´ ì„¸ì…˜ì„ ìƒì„±í•˜ê³  ë¦¬ë‹¤ì´ë ‰íŠ¸í•œë‹¤. ë§Œì•½ ë‘˜ì¤‘í•˜ë‚˜ë¼ë„ ë§Œì¡±í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´, ë¡œê·¸ì¸í™”ë©´ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ í•œë‹¤.

ë‹¤ìŒìœ¼ë¡œ, ì„¸ì…˜ì„ ëŠëŠ” ê²ƒì„ êµ¬í˜„í•´ ë³´ì.

ì•„ë˜ ë¼ìš°íŒ…ì„ ì‘ì„±í•œë‹¤.

```ruby
delete 'logout' => 'sessions#destroy'
```

ê·¸ í›„ ì„¸ì…˜ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ destroy ì•¡ì…˜ì„ êµ¬í˜„í•œë‹¤.

```ruby
def destroy
  session[:user_id] = nil
  redirect_to '/'
end
```

ì„¸ì…˜ì„ ëë‚´ëŠ” ê²ƒì€ ë¡œê·¸ì•„ì›ƒì„ ì˜ë¯¸í•œë‹¤. ë¡œê·¸ì•„ì›ƒì„ í•˜ë©´, ì„¸ì…˜ì˜ ê°’ì„ nilë¡œ ì„¤ì •í•´ ì£¼ë©´ ëœë‹¤.

## 4. Current_user

ì´ì œ ë¡œê·¸ì¸í•œ ìƒíƒœì™€ ë¡œê·¸ì•„ì›ƒì„ í•œ ìƒíƒœì—ì„œ ë‹¤ë¥¸ í˜ì´ì§€ë¥¼ ë³´ì—¬ì£¼ê³  ì‹¶ë‹¤. ì´ëŸ¬í•œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ `current_user`ë©”ì„œë“œë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

 **app/controllers/application_controller.rb**ì— ì•„ë˜ ë©”ì„œë“œë¥¼ ì¶”ê°€í•œë‹¤.

```ruby
helper_method :current_user

def current_user
  @current_user ||= User.find(session[:user_id]) if session[:user_id]
end

def require_user
  redirect_to '/login' unless current_user
end
```

1.  `current_user` methodëŠ” ìœ ì €ê°€ ë¡œê·¸ì¸ ë˜ì–´ìˆëŠ”ì§€ ì•„ë‹Œì§€ íŒë³„í•œë‹¤. ì£¼ì–´ì§„ session idì˜ ìœ ì €ê°€ ë°ì´í„°ë² ì´ìŠ¤ ìƒì— ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ì‘ì—…ì„ í†µí•´ íŒë³„í•  ìˆ˜ ìˆë‹¤. ë§Œì•½ ìœ ì €ê°€ ìˆë‹¤ë©´, ìœ ì €ê°€ ë¡œê·¸ì¸ ë˜ì–´ìˆë‹¤ëŠ” ì˜ë¯¸ì´ê³ , `@current_user`ì— í•´ë‹¹ ìœ ì €ë¥¼ ì €ì¥í•  ê²ƒì´ë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´, ìœ ì €ëŠ” ê³ ë¥´ì•„ì›ƒ ëœ ê²ƒì´ê³ ,  `@current_user` ì—ëŠ” `nil`ì´ ë“¤ì–´ê°„ë‹¤.
2. `helper_method :current_user` ë¼ì¸ì€  `current_user` ë©”ì„œë“œë¥¼ ë·°ì—ì„œ ì‚¬ìš©ê°€ëŠ¥í•˜ë„ë¡ ë§Œë“¤ì–´ ì¤€ë‹¤. ê·¸ë¦¬ê³  ê¸°ë³¸ì ìœ¼ë¡œ, Application Controllerì—ì„œ ì •ì˜ëœ ëª¨ë“  ë©”ì„œë“œë“¤ì€ ëª¨ë“  ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
3. `require_user` methodëŠ” `current_user` methodë¥¼ ì‚¬ìš©í•˜ì—¬ ë¡œê·¸ì•„ì›ƒëœ ìœ ì €ë“¤ì„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹œí‚¨ë‹¤.

ì˜ˆë¥¼ë“¤ì–´ ì•¨ë²” ì‚¬ì§„ì„ ë¡œê·¸ì¸ ìƒíƒœì—ì„œë§Œ ë³´ì—¬ì£¼ê³  ì‹¶ë‹¤ë©´, `require_user`ë©”ì„œë“œë¥¼ Albums controllerì— ë„£ì–´ì•¼ í•œë‹¤.

ì´ê²ƒì€ logoutëœ usersê°€ í˜ì´ì§€ì— ì ‘ê·¼í•˜ëŠ” ê²ƒì„ ë§‰ì•„ì¤€ë‹¤.

```ruby
before_action :require_user, only: [:index, :show]
```

indexë‚˜ show ì•¡ì…˜ì„ ìˆ˜í–‰í•˜ê¸° ì „ì— `before_action` ì€  `require_user` methodë¥¼ í˜¸ì¶œí•œë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤.

ê·¸ë¦¬ê³ , ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì„ ë”°ë¡œ ë§Œë“¤ì–´ì£¼ì–´ì•¼ í•œë‹¤.

**app/views/layouts/application.html.erb**ì— ì•„ë˜ì½”ë“œë¥¼ ì‚½ì…í•˜ì—¬ ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì„ ê°ê° ë‹¤ë¥´ê²Œ ì¤„ ìˆ˜ ìˆë‹¤.

```erb
<% if current_user %>
  <ul>
    <li><%= current_user.email %></li>
    <li><%= link_to "Log out", logout_path, method: "delete" %></li>
  </ul>
<% else %>
  <ul>
    <li><%= link_to "Login", 'login' %></a></li>
    <li><%= link_to "Signup", 'signup' %></a></li>
  </ul>
<% end %>
```
