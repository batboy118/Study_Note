# 02. Rails - Associations I

>

[ğŸ Home](https://github.com/batboy118/Study_Note)

[â—€Previous page ](./README.md)

---

<!-- TOC -->

- [1. ë” ë§ì€ ëª¨ë¸ ì‚¬ìš©í•˜ê¸°](#1-ë”-ë§ì€-ëª¨ë¸-ì‚¬ìš©í•˜ê¸°)
- [2. Migrate íŒŒì¼](#2-migrate-íŒŒì¼)
- [3. Index Tag](#3-index-tag)
- [4. Show Tag](#4-show-tag)
- [5. Show destination](#5-show-destination)
- [6. update destination](#6-update-destination)

<!-- /TOC -->

## 1. ë” ë§ì€ ëª¨ë¸ ì‚¬ìš©í•˜ê¸°

ì§€ê¸ˆê¹Œì§€ í•˜ë‚˜ì˜ ëª¨ë¸ë§Œì„ ì´ìš©í•œ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ë§Œë“¤ì–´ ë³´ì•˜ë‹¤ë©´ ì§€ê¸ˆ ë¶€í„°ëŠ” ì—¬ëŸ¬ê°œì˜ ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ í™œìš©í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ì„œ ì•Œì•„ë³´ì.

ë‘ ì¢…ë¥˜ ì´ìƒì˜ ë°ì´í„°ëŠ” ì„œë¡œ ë‹¤ë¥¸ ì»¬ëŸ¼ì„ ê°€ì§€ê²Œ ëœë‹¤. ì´ë•Œ í•˜ë‚˜ì˜ ëª¨ë¸ì—ì„œ ëª¨ë‘ ì²˜ë¦¬í•˜ê²Œë˜ë©´ ëª¨ë¸ì´ ì§€ì €ë¶„í•´ì§„ë‹¤. ì´ ê²½ìš°ì—ëŠ” ì—¬ëŸ¬ê°œì˜ ëª¨ë¸ì„ ì‚¬ìš©í•´ì„œ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆë‹¤.

**TravelApp**ì´ë¼ëŠ” ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ë§Œë“¤ì–´ ë³´ë©´ì„œ ë‘ê°œì˜ ëª¨ë¸ì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ì„œ ì•Œì•„ë³´ê² ë‹¤.

ì•ì˜ ê³¼ì •ì€ ìƒëµí•˜ê³  ëª¨ë¸ì„ ìƒì„±í•˜ëŠ” ë‹¨ê³„ë¶€í„° ì‚´í´ë³´ì.

`Tag`ëª¨ë¸ê³¼ `Destination`ë¼ëŠ” ëª¨ë¸ì„ generateí•˜ì.

```
rails generate model Tag
rails generate model Destination
```

tag ëª¨ë¸ íŒŒì¼ì¸ **app/models/tag.rb**ì— `has_many` methodë¥¼ ì•„ë˜ì™€ ê°™ì´ ì¶”ê°€í•œë‹¤.

```ruby
class Tag < ActiveRecord::Base
  has_many :destinations
end
```

destinationëª¨ë¸ íŒŒì¼ì¸ **app/models/destination.rb**ì— `belongs_to` methodë¥¼ ì•„ë˜ì™€ ê°™ì´ ì¶”ê°€í•œë‹¤.

```ruby
belongs_to :tag
```

- `has_many :destinations` denotes that a single Tag can have multiple Destinations.
- `belongs_to :tag` denotes that each Destination belongs to a single Tag.

ì¦‰, TagëŠ” ì—¬ëŸ¬ê°œì˜ destinationì„ ê°€ì§ˆìˆ˜ ìˆê³ , ëª¨ë“  destinationì€ í•˜ë‚˜ì˜ Tagì— ì†í•´ìˆì–´ì•¼ í•œë‹¤.

 `has_many` / `belongs_to` ëŠ” ì§ìœ¼ë¡œ one-to-many ê´€ê³„ì—ì„œ ìì£¼ ì‚¬ìš©ëœë‹¤.

- a Library has many Books; a Book belongs to a Library
- an Album has many Photos; a Photo belongs to an Album
- a Store has many Products; a Product belongs to a Store

## 2. Migrate íŒŒì¼

`db/migrate/` ì— ìˆëŠ” tag í…Œì´ë¸”ì— string í˜•ì˜ titleê³¼ image ì»¬ëŸ¼ì„ ì¶”ê°€í•œë‹¤.

```ruby
class CreateTags < ActiveRecord::Migration
  def change
    create_table :tags do |t|
      t.string :title
      t.string :image
      t.timestamps
    end
  end
end
```

destinations tableë„ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •í•´ ì¤€ë‹¤.

```ruby
class CreateDestinations < ActiveRecord::Migration
  def change
    create_table :destinations do |t|
      t.string :name
      t.string :image
      t.string :description
      t.references :tag
      t.timestamps
    end
  end
end
```

DBë¥¼ Tagì™€ Destination í…Œì´ë¸”ì„ ì´ìš©í•˜ì—¬ ì—…ë°ì´íŠ¸ í•˜ê¸° ìœ„í•´ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹¤í–‰í•œë‹¤.

```
bundle exec rake db:migrate
```

`db/seeds.rb` íŒŒì¼ì— ì•„ë˜ì™€ ê°™ì´ ì…ë ¥ë˜ì–´ ìˆë‹¤ê³  ê°€ì •í•˜ì.

```ruby

t1 = Tag.create(title: "Beaches", image: "http://s3.amazonaws.com/codecademy-content/courses/learn-rails/img/beach01.jpg")
Destination.create(name: "Ipanema", description: "The beach of Ipanema is known for its elegant development and its social life.", image: "http://s3.amazonaws.com/codecademy-content/courses/learn-rails/img/beach02.jpg", tag_id: t1.id)
Destination.create(name: "7 Mile Beach", description: "The western coastline contains the island's finest beaches.", image: "http://s3.amazonaws.com/codecademy-content/courses/learn-rails/img/beach03.jpg", tag_id: t1.id)
Destination.create(name: "El Castillo", description: "An elite destination famous for its white sand beaches", image: "http://s3.amazonaws.com/codecademy-content/courses/learn-rails/img/beach04.jpg", tag_id: t1.id)

t2 = Tag.create(title: "History", image: "http://s3.amazonaws.com/codecademy-content/courses/learn-rails/img/history01.jpg")
Destination.create(name: "Machu Picchu", description: "Machu Picchu was built around 1450, at the height of the Inca Empire.", image: "http://s3.amazonaws.com/codecademy-content/courses/learn-rails/img/history02.jpg", tag_id: t2.id)
Destination.create(name: "Dunrobin Castle", description: "Dunrobin Castle is a stately home in Sutherland. Its origins lie in the Middle Ages.", image: "http://s3.amazonaws.com/codecademy-content/courses/learn-rails/img/history03.jpg", tag_id: t2.id)
Destination.create(name: "Palace of Westminster", description: "The meeting place of the two houses of the Parliament of the United Kingdom", image: "http://s3.amazonaws.com/codecademy-content/courses/learn-rails/img/history04.jpg", tag_id: t2.id)

t3 = Tag.create(title: "Skiing", image: "http://s3.amazonaws.com/codecademy-content/courses/learn-rails/img/skiing01.jpg")
Destination.create(name: "Dolomites", description: "The Dolomites are a mountain range located in northeastern Italy famous for skiing in the winter months.", image: "http://s3.amazonaws.com/codecademy-content/courses/learn-rails/img/skiing02.jpg", tag_id: t3.id)
Destination.create(name: "Chamonix", description: "It was the site of the first Winter Olympics in 1924", image: "http://s3.amazonaws.com/codecademy-content/courses/learn-rails/img/skiing03.jpg", tag_id: t3.id)
Destination.create(name: "Vail", description: "The second largest single mountain ski resort in the United States", image: "http://s3.amazonaws.com/codecademy-content/courses/learn-rails/img/skiing04.jpg", tag_id: t3.id)

t4 = Tag.create(title: "Adventure", image: "http://s3.amazonaws.com/codecademy-content/courses/learn-rails/img/adventure01.jpg")
Destination.create(name: "Banzai Pipeline", description: "A surf reef break located in Hawai notorious for huge waves.", image: "http://s3.amazonaws.com/codecademy-content/courses/learn-rails/img/adventure02.jpg", tag_id: t4.id)
Destination.create(name: "Saxon Switzerland", description: "A hilly climbing area and national park in Saxony, Germany.", image: "http://s3.amazonaws.com/codecademy-content/courses/learn-rails/img/adventure03.jpg", tag_id: t4.id)
Destination.create(name: "Pucon", description: "Striking natural surroundings near a volcano and several lakes, nature reserves and thermal baths.", image: "http://s3.amazonaws.com/codecademy-content/courses/learn-rails/img/adventure04.jpg", tag_id: t4.id)

t5 = Tag.create(title: "Family", image: "http://s3.amazonaws.com/codecademy-content/courses/learn-rails/img/family01.jpg")
Destination.create(name: "British Museum", description: "A museum dedicated to human history and culture, with over 8 million works.", image: "http://s3.amazonaws.com/codecademy-content/courses/learn-rails/img/family02.jpg", tag_id: t5.id)
Destination.create(name: "San Diego Zoo", description: "Houses over 3,700 animals of more than 650 species and subspecies.", image: "http://s3.amazonaws.com/codecademy-content/courses/learn-rails/img/family03.jpg", tag_id: t5.id)
Destination.create(name: "Central Park", description: "The most visited urban park in the US as well as one of the most filmed locations in the world.", image: "http://s3.amazonaws.com/codecademy-content/courses/learn-rails/img/family04.jpg", tag_id: t5.id)
```

ì´ seedë°ì´í„°ë¥¼ ì´ìš©í•˜ì—¬ ë°ì´í„° ë² ì´ìŠ¤ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ `bundle exec rake db:seed` ì„ ì‹¤í–‰í•œë‹¤.

> ìœ„ ê³¼ì •ë“¤ì„ ì •ë¦¬í•´ ë³´ë©´,
>
> ë‘ ê°œì˜ string columns `title` , `image` ë¥¼ tags tableì— ì¶”ê°€í–ˆë‹¤.
>
> ì„¸ ê°œì˜ string columns `name`, `image`, `description`destinations tableì— ì¶”ê°€í–ˆë‹¤.
>
> `t.references :tag`ë¥¼  destinations tableì— ì¶”ê°€í–ˆë‹¤. ì´ ê²ƒì€ tag í…Œì´ë¸”ì„ ê°€ë¦¬í‚¤ëŠ”  `foreign key` ë¥¼ ì¶”ê°€í•œë‹¤.
>
> ë§ˆì§€ë§‰ìœ¼ë¡œ ë°ì´í„° ë² ì´ìŠ¤ë¥¼ ì—…ë°ì´íŠ¸ í•˜ê¸° ìœ„í•´ migrations ì„ ìˆ˜í–‰í•˜ê³ , **db/seeds.rb** ë¥¼ ì´ìš©í•´ ë°ì´í„° ë² ì´ìŠ¤ì— ì´ˆê¸° ë°ì´í„°ë¥¼ ì„¤ì •í–ˆë‹¤.

## 3. Index Tag

 `Tags` ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ìƒì„±í•˜ê³  ë¼ìš°í„° íŒŒì¼ì—ì„œ  `/tags` ì™€  `index` actionë¥¼ ë§µí•‘ ì‹œí‚¨ë‹¤.

Index ì•¡ì…˜ì—ì„œëŠ” dbì—ì„œ ëª¨ë“  tagë°ì´í„°ë¥¼ ê°€ì ¸ì™€ `@tags`ì— ì €ì¥í•œë‹¤.

```ruby
class TagsController < ApplicationController
  def index
    @tags = Tag.all
  end
end
```

**app/views/tags/index.html.erb** ì—ì„œ ëª¨ë“  @tagë¥¼ ìˆœíšŒí•˜ë©° ì´ë¯¸ì§€ì™€ íƒ€ì´í‹€ì„ ì¨ì¤€ë‹¤.

```ruby
<% @tags.each do |tag| %>
	<div class="card col-xs-4">
  	<%= image_tag(tag.image) %>
  	<h2> <%= tag.title %> </h2>
  </div>
<% end %>
```

image_tag ë©”ì†Œë“œëŠ” urlì— í•´ë‹¹í•˜ëŠ” ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì™€ ì¤€ë‹¤.

## 4. Show Tag

`show` actionì„ ì´ìš©í•´ì„œ íŠ¹ì • idì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ë§Œ ë³´ì—¬ì£¼ëŠ” ê¸°ëŠ¥ì„ ë§Œë“¤ì–´ë³´ì.

ë¨¼ì € ë¼ìš°íŠ¸ íŒŒì¼ì— ì•„ë˜ ë‚´ìš©ì„ ë„£ëŠ”ë‹¤. (`resources :tags`ë¥¼ ì‚¬ìš©í•˜ë©´ ë”°ë¡œ ë„£ì„ í•„ìš”ëŠ” ì—†ìŒ)

```ruby
get '/tags/:id' => 'tags#show', as: :tag
```

ì—¬ê¸°ì„œ  `as:` ë¥¼ ì‚¬ìš©í•´ ì´ ë¼ìš°íŠ¸ì˜ ì´ë¦„ì„ â€œtagâ€ë¡œ ì„¤ì •í•œë‹¤.

show ì•¡ì…˜ë„ ì¶”ê°€í•œë‹¤.

```ruby
def show
  @tag = Tag.find(params[:id])
  @destinations = @tag.destinations
end
```

**app/views/tags/show.html.erb**showì˜ í…œí”Œë¦¿ì—ì„œ ë°ì´í„°ë¥¼ ì´ìš©í•˜ëŠ” ë¶€ë¶„ì€ ì•„ë˜ì™€ ê°™ì´ ì‘ì„±í•  ìˆ˜ ìˆë‹¤.

```erb
<h2 class="tag-title"> <%= @tag.title %> </h2>

<% @destinations.each { |d|%>
  <div class="card col-xs-4">
    <%= image_tag(d.image) %>
    <h2> <%= d.name %> </h2>
    <p> <%= d.description %> </p>
  </div>
<% } %>
```

**app/views/tags/index.html.erb** ì˜  `<% @tags.each do |t| %>...<% end %>` blockì•ˆì— ì•„ë˜ ë‚´ìš©ì„ ì¶”ê°€í•´ tagë§ˆë‹¤ ë§í¬ë¥¼ ë§Œë“¤ì–´ ì¤€ë‹¤.

```erb
<%= link_to "Learn more", tag_path(t) %>
```

`get '/tags/:id' => 'tags#show', as: :tag ` ì—ì„œ tagë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ì§€ì •í–ˆê¸° ë•Œë¬¸ì— ìë™ìœ¼ë¡œ tag_pathë¼ëŠ” ì´ë¦„ì˜ ë©”ì„œë“œê°€ ìƒì„±ëœë‹¤. ì´ ë©”ì„œë“œë¥¼ ì´ìš©í•´ ë§í¬ë§ˆë‹¤ íŠ¹ì • urlì„ ì„¤ì •í•´ ì¤„ ìˆ˜ ìˆë‹¤. ì´ ê²½ìš°ëŠ” urlì´ `tags/:id` ì´ë¯€ë¡œ id ê°’ì´ìš©  (ì˜ˆ>  `/tag/1`)

ì´ì œ ë§í¬ë¥¼ ëˆŒëŸ¬ë³´ë©´ íƒœê·¸ì— í•´ë‹¹í•˜ëŠ” ëª©ì ì§€ë“¤ì´ ë¦¬ìŠ¤íŒ… ë˜ëŠ” ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆë‹¤.

ìœ„ ê³¼ì •ë“¤ì„ ë‹¤ì‹œ í•˜ë²ˆ ì •ë¦¬í•˜ë©´ ì•„ë˜ì™€ ê°™ë‹¤.

-  `http://localhost:8000/tags/1`ì— ì ‘ì†í•˜ë©´ ë¼ìš°íŠ¸ íŒŒì¼ì˜  `get '/tags/:id' => 'tags#show'`ì— ì˜í•´ Tags controllerì˜ show actionë¡œ paramsì— `{id: 1}`ì´ ì €ì¥ë˜ì–´ ìš”ì²­ì´ ì „ë‹¬ëœë‹¤.
- `@destinations = @tag.destinations` ëŠ” í•´ë‹¹ tagì— ì†í•´ìˆëŠ” ëª¨ëŠ” destinationë“¤ì„ `@destinations`ì— ì €ì¥í•œë‹¤.  `has_many` / `belongs_to` associationì„ í†µí•´ tagì— ì†í•´ìˆëŠ” ëª¨ë“  destinationì˜ ë°ì´í„°ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤.s

## 5. Show destination

Destinations ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ generateí•œë‹¤.

ë¼ìš°íŠ¸ íŒŒì¼ì— ë§µí•‘ì„ ì‹œì¼œì¤€ë‹¤.

```ruby
get '/destinations/:id' => 'destinations#show', as: :destination
```

Destinations controllerì— show ì•¡ì…˜ì„ ì¶”ê°€í•œë‹¤. ë¼ìš°íŠ¸ íŒŒì¼ì—ì„œ `:id`ê°€ í¬í•¨ëœ paramsë¥¼ ìš”ì²­ê³¼ í•¨ê»˜ showì•¡ì…˜ìœ¼ë¡œ ì „ë‹¬í•œë‹¤.

```ruby
class DestinationsController < ApplicationController
  def show
    @destination = Destination.find(params[:id])
  end
end
```

**app/views/destinations/show.html.erb** ë·° íŒŒì¼ì„ ìˆ˜ì •í•œë‹¤. destinationì˜ image, name, descriptionì„ í‘œí˜„í•œë‹¤.

```ruby
<%= image_tag @destination[:image] %>
<h2> <%= @destination[:name] %> </h2>
<%= @destination[:description] %>
```

ë§ˆì§€ë§‰ìœ¼ë¡œ **app/views/tags/show.html.erb** íŒŒì¼ì—ì„œ ì´ì „ì— ì¶”ê°€í•œ ë¸”ëŸ­ì— ê°ê°ì˜ destinationì— ì ‘ê·¼í•˜ê¸° ìœ„í•œ ë§í¬ë¥¼ ìƒì„±í•´ ì¤€ë‹¤.

 `link_to` ë¥¼ ì´ìš©í•œë‹¤.

```ruby
<%= link_to "See more", destination_path(d) %>
```

- ì•ì—ì„œ `show` routeì—  â€œdestinationâ€ì´ë¼ëŠ” ì´ë¦„ì„ ì„¤ì •í•´ ì£¼ì—ˆê¸° ë•Œë¬¸ì— ë ˆì¼ì¦ˆì—ì„œëŠ”`destination_path`ë¼ëŠ”  helper methodë¥¼ ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ ì¤€ë‹¤. ê·¸ ë©”ì„œë“œë¥¼ ì´ìš©í•˜ì—¬ ê° destinationì— ë§ê²Œ urlì„ ì„¤ì •í•´ ì¤€ë‹¤.

í˜ì´ì§€ë¥¼ ì—´ì–´ ë§í¬ë¥¼ í´ë¦­í•˜ë©´ ê° destination ì†Œê°œ ë‚´ìš©ì´ ë‚˜ì˜¤ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

## 6. update destination

destinationì˜ nameê³¼ descriptionì„ ì—…ë°ì´íŠ¸ í•˜ê¸° ìœ„í•´ actionì„ ì¶”ê°€í•´ì•¼ í•œë‹¤. `edit`ê³¼ `update` actionì„ ì¶”ê°€í•  ê²ƒì´ë‹¤. (ê¸°ë³¸ì ì¸ 7ê°€ì§€ actionì— í¬í•¨ë˜ì–´ ìˆë‹¤.)

**config/routes.rb**ì— ì•„ë˜ ë¼ìš°íŒ…ì„ ì¶”ê°€í•œë‹¤.

```ruby
get '/destinations/:id/edit' => 'destinations#edit', as: :edit_destination 
patch '/destinations/:id' => 'destinations#update' 
```

Destinations controllerì— `show` actionì„ ì¶”ê°€í•œë‹¤. ê·¸ë¦¬ê³ , privateìœ¼ë¡œ destination_params ì„ ì¶”ê°€í•˜ê³ , update actionë„ ì¶”ê°€í•´ì¤€ë‹¤.

```ruby
class DestinationsController < ApplicationController
  def show
    @destination = Destination.find(params[:id])
  end
    
  def edit 
    @destination = Destination.find(params[:id]) 
  end
    
  def update 
    @destination = Destination.find(params[:id]) 
    if @destination.update_attributes(destination_params) 
      redirect_to(:action => 'show', :id => @destination.id) 
    else 
      render 'edit' 
    end 
  end
    
  private 
  def destination_params 
    params.require(:destination).permit(:name, :description) 
  end 
end
```

ìˆ˜ì •í™”ë©´ì„ ë³´ì—¬ì£¼ê¸° ìœ„í•´ **app/views/destinations/edit.html.erb** íŒŒì¼ì„ ìˆ˜ì •í•´ì•¼ í•œë‹¤.

`@destination` objectì˜ í•„ë“œ í¼ì„ ìƒì„±í•˜ê¸° ìœ„í•´  `form_for`ì„ ì‚¬ìš©í•œë‹¤.

```erb
<%= form_for(@destination) do |f| %>
    <%= f.text_field :name %></br>
    <%= f.text_area :description %>
    <div class="actions">
        <%= f.submit "Edit" %>
    </div>
<% end %>
```

 **app/views/destinations/show.html.erb**íŒŒì¼ì— Edit ë§í¬ë¥¼ ì¶”ê°€í•´ì¤€ë‹¤.

```erb
<%= link_to "Edit", edit_destination_path(@destination) %>
```

ìœ„ ê³¼ì •ì„ ì ‘ê·¼í•˜ë©´ ì•„ë˜ì™€ ê°™ë‹¤.

> When you visit`http://localhost:8000/destinations/1/edit` to edit a destination, it triggers the first turn of the request/response cycle:
>
> 1. The browser makes a HTTP GET request for the URL `/destinations/1/edit`.
> 2. The Rails router maps this URL to the Destinations controllerâ€™s `edit` action. The `edit` action finds the destination with id 1, stores it in `@destination`, and passes it on to the view **app/views/destinations/edit.html.erb**.
> 3. In the view, `form_for` creates a form with the fields of the `@destinations` object.
>
> Then when you fill out the form and submit it, it triggers the second turn of the request/response cycle:
>
> 1. The browser sends the data to the Rails app via an **HTTP PATCH** request to the URL `/destinations/update`.
> 2. This time, the Rails router maps this URL to the `update` action.
> 3. The `update` uses the `destination_params` method to safely collect data from the form. It finds the destination in the database, updates its attributes, and redirects to the destinationâ€™s `show` page.

- We connected a Tag to its Destinations using *associations*. In this case, a tag `has_many` destinations, and a destination `belongs_to` one tag.

- The `has_many` / `belongs_to` pair can be used to model other one-to-many relationships, which occur frequently.
- Rails provides [seven standard controller actions](https://www.codecademy.com/articles/standard-controller-actions) can be used to do common things such as display and change data